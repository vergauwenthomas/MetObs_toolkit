
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>metobs_toolkit.analysis &#8212; metobs_toolkit 0.1.3a documentation</title>



  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />


  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=a7314d79" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=57d30286"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/metobs_toolkit/analysis';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>


  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">



  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>

  <div id="pst-scroll-pixel-helper"></div>

  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>


  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>

  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>

  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>


  <div class="col-lg-3 navbar-header-items__start">

      <div class="navbar-item">



<a class="navbar-brand logo" href="../../index.html">










    <img src="../../_static/logo_small.svg" class="logo__image only-light" alt="metobs_toolkit 0.1.3a documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo_small.svg" class="logo__image only-dark" alt="metobs_toolkit 0.1.3a documentation - Home"/>`);</script>


</a></div>

  </div>

  <div class="col-lg-9 navbar-header-items">

    <div class="me-auto navbar-header-items__center">

        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../index.html">
                        Home
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../intro.html">
                        Getting started
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../specific_topics.html">
                        Specific topics
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../examples/index.html">
                        Examples
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../MetObs_documentation_flat.html">
                        Documentation
                      </a>
                    </li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../topics/contributing_link.html">
                        Contributing
                      </a>
                    </li>

                </ul>
            </li>

  </ul>
</nav></div>

    </div>


    <div class="navbar-header-items__end">

        <div class="navbar-item navbar-persistent--container">


 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>


        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>

        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">








          <a href="https://github.com/vergauwenthomas/MetObs_toolkit" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-github-square fa-xl fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>

    </div>

  </div>


    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>



</div>

    </header>


  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">





      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">



  <div class="sidebar-header-items sidebar-primary__section">


      <div class="sidebar-header-items__center">

          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../index.html">
                        Home
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../intro.html">
                        Getting started
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../specific_topics.html">
                        Specific topics
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../examples/index.html">
                        Examples
                      </a>
                    </li>


                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../MetObs_documentation_flat.html">
                        Documentation
                      </a>
                    </li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links-2">
                    More
                </button>
                <ul id="pst-nav-more-links-2" class="dropdown-menu">

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../topics/contributing_link.html">
                        Contributing
                      </a>
                    </li>

                </ul>
            </li>

  </ul>
</nav></div>

      </div>



      <div class="sidebar-header-items__end">

          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>

          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">








          <a href="https://github.com/vergauwenthomas/MetObs_toolkit" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-github-square fa-xl fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>

      </div>

  </div>


  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>

  <div id="rtd-footer-container"></div>


      </div>

      <main id="main-content" class="bd-main">


          <div class="bd-content">
            <div class="bd-article-container">

              <div class="bd-header-article">
<div class="header-article-items header-article__inner">

    <div class="header-article-items__start">

        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">

    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>

    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>

    <li class="breadcrumb-item active" aria-current="page">metobs_toolk...</li>
  </ul>
</nav>
</div>

    </div>


</div>
</div>




<div id="searchbox"></div>
                <article class="bd-article">

  <h1>Source code for metobs_toolkit.analysis</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the Analysis class and all its methods.</span>

<span class="sd">A Analysis holds a set of &#39;good&#39; observations and the methods will analyse it.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.plotting_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cycle_plot</span><span class="p">,</span>
    <span class="n">heatmap_plot</span><span class="p">,</span>
    <span class="n">correlation_scatter</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.df_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_subsetting</span><span class="p">,</span>
    <span class="n">subset_stations</span><span class="p">,</span>
    <span class="n">fmt_datetime_argument</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Analysis">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.html#metobs_toolkit.analysis.Analysis">[docs]</a>
<span class="k">class</span> <span class="nc">Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Analysis class contains methods for analysing observations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Analysis.__init__">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.html#metobs_toolkit.analysis.Analysis.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obsdf</span><span class="p">,</span> <span class="n">metadf</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_template</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an Analysis.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">obsdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_template</span> <span class="o">=</span> <span class="n">data_template</span>

        <span class="c1"># analysis objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lc_cor_obstype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># add empty lcz column to metadf if it is not present</span>
        <span class="k">if</span> <span class="s2">&quot;lcz&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lcz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a overview of the analysis.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Empty Analysis instance.&quot;</span>
        <span class="n">add_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">n_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_obs_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">startdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">enddt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">add_info</span> <span class="o">+=</span> <span class="s2">&quot;     *Coordinates are available for all stations. </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lcz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">add_info</span> <span class="o">+=</span> <span class="s2">&quot;     *LCZ&#39;s are available for all stations. </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="p">):</span>
            <span class="n">add_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;     *landcover correlations are computed on group: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span><span class="si">}</span><span class="s2">  </span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Analysis instance containing: </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="n">n_stations</span><span class="si">}</span><span class="s2"> stations </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s2"> observation types </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="n">n_obs_tot</span><span class="si">}</span><span class="s2"> observation records </span><span class="se">\n</span><span class="si">{</span><span class="n">add_info</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *records range: </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2"> (total duration:  </span><span class="si">{</span><span class="n">enddt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startdt</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="o">+</span> <span class="n">add_info</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print a overview of the analysis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="c1"># =============================================================================</span>
    <span class="c1">#     Setters</span>
    <span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Analysis.subset_period">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.subset_period.html#metobs_toolkit.analysis.Analysis.subset_period">[docs]</a>
    <span class="k">def</span> <span class="nf">subset_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startdt</span><span class="p">,</span> <span class="n">enddt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subset the observations of the Analysis to a specific period.</span>

<span class="sd">        The same timezone is assumed as the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        startdt : datetime.datetime</span>
<span class="sd">            The start datetime to filter the observations to.</span>
<span class="sd">        enddt : datetime.datetime</span>
<span class="sd">            The end datetime to filter the observations to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startdt</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> not a datetime type. Ignore subsetting!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">enddt</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2"> not a datetime type. Ignore subsetting!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">startdt</span> <span class="o">=</span> <span class="n">fmt_datetime_argument</span><span class="p">(</span>
            <span class="n">startdt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">enddt</span> <span class="o">=</span> <span class="n">fmt_datetime_argument</span><span class="p">(</span><span class="n">enddt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">datetime_subsetting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">startdt</span><span class="p">,</span> <span class="n">enddt</span><span class="p">)</span></div>


    <span class="c1"># =============================================================================</span>
    <span class="c1">#   Helpers</span>
    <span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Analysis.apply_filter">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.apply_filter.html#metobs_toolkit.analysis.Analysis.apply_filter">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter an Analysis by a user definde string expression.</span>

<span class="sd">        This can be used to filter the observation to specific meteorological</span>
<span class="sd">        conditions (i.e. low windspeeds, high humidity, cold temperatures, ...)</span>

<span class="sd">        The filter expression contains only columns present in the Analysis.df</span>
<span class="sd">        and/or the Analysis.metadf.</span>

<span class="sd">        A New Analysis object is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expression : str</span>
<span class="sd">            A filter expression using columnnames present in either df or metadf.</span>
<span class="sd">            The following timestamp derivatives can be used as well: [minute, hour,</span>
<span class="sd">            month, year, day_of_year, week_of_year, season]. The quarry_str may</span>
<span class="sd">            contain number and expressions like &lt;, &gt;, ==, &gt;=, \*, +, .... Multiple filters</span>
<span class="sd">            can be combine to one expression by using &amp; (AND) and | (OR).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filtered_analysis : metobs_toolkit.Analysis</span>
<span class="sd">            The filtered Analysis.</span>


<span class="sd">        Note</span>
<span class="sd">        -------</span>
<span class="sd">        All timestamp derivative values are numeric except for &#39;season&#39;,</span>
<span class="sd">        possible values are [&#39;winter&#39;, &#39;spring&#39;, &#39;summer&#39;, &#39;autumn&#39;].</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>
<span class="sd">        Make shure to use \&quot; of \&#39; to indicate string values in the expression if</span>
<span class="sd">        needed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">child_df</span><span class="p">,</span> <span class="n">child_metadf</span> <span class="o">=</span> <span class="n">filter_data</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span> <span class="n">quarry_str</span><span class="o">=</span><span class="n">expression</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">Analysis</span><span class="p">(</span>
            <span class="n">obsdf</span><span class="o">=</span><span class="n">child_df</span><span class="p">,</span>
            <span class="n">metadf</span><span class="o">=</span><span class="n">child_metadf</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
            <span class="n">data_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Analysis.aggregate_df">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.aggregate_df.html#metobs_toolkit.analysis.Analysis.aggregate_df">[docs]</a>
    <span class="k">def</span> <span class="nf">aggregate_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lcz&quot;</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate observations to a (list of) categories.</span>

<span class="sd">        The output will be a dataframe that is aggregated to one, or more</span>
<span class="sd">        categories. A commen example is aggregating to LCZ&#39;s.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame or None</span>
<span class="sd">            The observations to aggregate. If None, the df attribute of the</span>
<span class="sd">            Analysis instance is used. The default is None.</span>
<span class="sd">        agg : list, optional</span>
<span class="sd">            The list of columnnames to aggregate to. If &#39;lcz&#39; is included, the</span>
<span class="sd">            lcz information is extracted from the Analysis.metadf. The default</span>
<span class="sd">            is [&#39;lcz&#39;, &#39;datetime&#39;].</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            list of functions and/or function names, e.g. [np.sum, &#39;mean&#39;]. The</span>
<span class="sd">            default is &#39;mean&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            A dataframe with the agg columns as an index. The values are the</span>
<span class="sd">            aggregated values.</span>

<span class="sd">        Note</span>
<span class="sd">        -------</span>
<span class="sd">        Present columns that ar non-numeric and are not in the agg list, are</span>
<span class="sd">        not present in the return, since these values cannot be aggregated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">time_agg_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;minute&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hour&quot;</span><span class="p">,</span>
            <span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;day_of_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;week_of_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;season&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># scan trough the metadf for aggregation keys</span>
        <span class="k">for</span> <span class="n">agg_key</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">agg_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># look in metadf</span>
                <span class="k">if</span> <span class="n">agg_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">df</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[[</span><span class="n">agg_key</span><span class="p">]],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
                        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Check if all agg keys are present or defined:</span>
        <span class="n">possible_agg_keys</span> <span class="o">=</span> <span class="n">time_agg_keys</span>
        <span class="n">possible_agg_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">unmapped</span> <span class="o">=</span> <span class="p">[</span><span class="n">agg_key</span> <span class="k">for</span> <span class="n">agg_key</span> <span class="ow">in</span> <span class="n">agg</span> <span class="k">if</span> <span class="n">agg_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_agg_keys</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmapped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cannot aggregate to unknown labels: </span><span class="si">{</span><span class="n">unmapped</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="c1"># make time-derivate columns if required</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_make_time_derivatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">agg</span><span class="p">)</span>

        <span class="c1"># check if not all values are Nan</span>
        <span class="k">for</span> <span class="n">agg_name</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">df</span><span class="p">[</span><span class="n">agg_name</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Aggregation to </span><span class="si">{</span><span class="n">agg_name</span><span class="si">}</span><span class="s2"> not possible because no valid values found for </span><span class="si">{</span><span class="n">agg_name</span><span class="si">}</span><span class="s2">.&quot;</span>

        <span class="c1"># remove datetime column if present, because no aggregation can be done on</span>
        <span class="c1"># datetime and it gives a descrepation warning</span>
        <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

        <span class="c1"># Remove name column if present and not in the aggregation scheme,</span>
        <span class="c1"># this happens because name was in the index</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

        <span class="c1"># Aggregate the df</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># descrepation warning</span>
        <span class="c1"># sort index</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="n">agg_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">agg_df</span></div>


    <span class="c1"># =============================================================================</span>
    <span class="c1">#   Analyse method</span>
    <span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="Analysis.get_anual_statistics">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.get_anual_statistics.html#metobs_toolkit.analysis.Analysis.get_anual_statistics">[docs]</a>
    <span class="k">def</span> <span class="nf">get_anual_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="n">obstype</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="n">agg_method</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">startdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enddt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">errorbands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_return_all_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an anual cycle for aggregated groups.</span>

<span class="sd">        (In the plot, unique combination of groupby categories is presented</span>
<span class="sd">         as a line.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        groupby : list string, optional</span>
<span class="sd">            Variables to aggregate to. These can be columns in the metadf, or</span>
<span class="sd">            time aggregations (&#39;hour&#39;, &#39;year&#39;, &#39;week_of_year&#39;, ...]. &#39;name&#39; will</span>
<span class="sd">            aggregate to the stationnames. The default is [&#39;name&#39;].</span>
<span class="sd">        obstype : str, optional</span>
<span class="sd">            Element of the metobs_toolkit.observation_types The default is &#39;temp&#39;.</span>
<span class="sd">        agg_method : str, optional</span>
<span class="sd">            Function names to use for aggregation, e.g. [np.sum, &#39;mean&#39;]. The</span>
<span class="sd">            default is &#39;mean&#39;.</span>
<span class="sd">        stations : list, optional</span>
<span class="sd">             List of station names to use. If None, all present stations will be used. The default is None.</span>
<span class="sd">        startdt : datetime.datetime, optional</span>
<span class="sd">            The start datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        enddt : datetime.datetime, optional</span>
<span class="sd">            The end datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            If True, an anual plot is made. The default is True.</span>
<span class="sd">        errorbands : bool, optional</span>
<span class="sd">             If True, the std is representd in the plot by colored bands. The default is False.</span>
<span class="sd">        title : string, optional</span>
<span class="sd">             Title of the figure, if None a default title is generated. The default is None.</span>
<span class="sd">        y_label : string, optional</span>
<span class="sd">             y-axes label of the figure, if None a default label is generated. The default is None.</span>
<span class="sd">        legend : bool, optional</span>
<span class="sd">             I True, a legend is added to the plot. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame()</span>
<span class="sd">            The dataframe containing the aggregated values.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># title</span>
        <span class="n">desc_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Anual </span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> cycle plot per </span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># ylabel</span>
        <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (units unknown)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_aggregated_cycle_statistics</span><span class="p">(</span>
            <span class="n">obstype</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span>
            <span class="n">aggregation_method</span><span class="o">=</span><span class="n">agg_method</span><span class="p">,</span>
            <span class="n">horizontal_axis</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="n">startdt</span><span class="o">=</span><span class="n">startdt</span><span class="p">,</span>
            <span class="n">enddt</span><span class="o">=</span><span class="n">enddt</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
            <span class="n">errorbands</span><span class="o">=</span><span class="n">errorbands</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">_return_all_stats</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="Analysis.get_diurnal_statistics">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.get_diurnal_statistics.html#metobs_toolkit.analysis.Analysis.get_diurnal_statistics">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diurnal_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">colorby</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">obstype</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">startdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enddt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">errorbands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">_return_all_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an average diurnal cycle for the observations.</span>

<span class="sd">        (In the plot, each station is represed by a line.)</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        colorby : &#39;name&#39; or &#39;lcz&#39;, optional</span>
<span class="sd">            If &#39;name&#39; the plotted lines will be colored per station, if &#39;lcz&#39; the colors represent the stations lcz. The default is &#39;name&#39;.</span>
<span class="sd">        obstype : str, optional</span>
<span class="sd">            Element of the metobs_toolkit.observation_types The default is &#39;temp&#39;.</span>
<span class="sd">        stations : list, optional</span>
<span class="sd">            List of station names to use. If None, all present stations will be used. The default is None.</span>
<span class="sd">        startdt : datetime.datetime, optional</span>
<span class="sd">            The start datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        enddt : datetime.datetime, optional</span>
<span class="sd">            The end datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            If True, an diurnal plot is made. The default is True.</span>
<span class="sd">        title : string, optional</span>
<span class="sd">             Title of the figure, if None a default title is generated. The default is None.</span>
<span class="sd">        y_label : string, optional</span>
<span class="sd">             y-axes label of the figure, if None a default label is generated. The default is None.</span>
<span class="sd">        legend : bool, optional</span>
<span class="sd">             I True, a legend is added to the plot. The default is True.</span>
<span class="sd">        errorbands : bool, optional</span>
<span class="sd">            If True, the std is representd in the plot by colored bands. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame()</span>
<span class="sd">            The dataframe containing the aggregated values.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># title</span>
        <span class="n">desc_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">startdt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enddt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle until </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enddt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle from </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle for period </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># ylabel</span>
        <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (units unknown)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_aggregated_cycle_statistics</span><span class="p">(</span>
            <span class="n">obstype</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="p">[</span><span class="n">colorby</span><span class="p">],</span>
            <span class="n">aggregation_method</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="n">horizontal_axis</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span>
            <span class="n">startdt</span><span class="o">=</span><span class="n">startdt</span><span class="p">,</span>
            <span class="n">enddt</span><span class="o">=</span><span class="n">enddt</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
            <span class="n">errorbands</span><span class="o">=</span><span class="n">errorbands</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">_return_all_stats</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="Analysis.get_diurnal_statistics_with_reference">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.get_diurnal_statistics_with_reference.html#metobs_toolkit.analysis.Analysis.get_diurnal_statistics_with_reference">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diurnal_statistics_with_reference</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">refstation</span><span class="p">,</span>
        <span class="n">colorby</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">obstype</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="n">tollerance</span><span class="o">=</span><span class="s2">&quot;30T&quot;</span><span class="p">,</span>
        <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">startdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enddt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">errorbands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_zero_horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_return_all_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an average diurnal cycle for the observation differences of a reference station.</span>

<span class="sd">        All observational values are converted to differences with the closest</span>
<span class="sd">        (in time) reference observation. No reference observation is found when</span>
<span class="sd">        the time difference is larger than the tollerance.</span>

<span class="sd">        (In the plot, each station is represed by a line.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        refstation : str,</span>
<span class="sd">            Name of the station to use as a reference.</span>
<span class="sd">        colorby : &#39;name&#39; or &#39;lcz&#39;, optional</span>
<span class="sd">            If &#39;name&#39; the plotted lines will be colored per station, if &#39;lcz&#39; the colors represent the stations lcz. The default is &#39;name&#39;.</span>
<span class="sd">        obstype : str, optional</span>
<span class="sd">            Element of the metobs_toolkit.observation_types The default is &#39;temp&#39;.</span>
<span class="sd">        tollerance : Timedelta or str, optional</span>
<span class="sd">            The tollerance string or object representing the maximum translation in time to find a reference</span>
<span class="sd">            observation for each observation. Ex: &#39;5T&#39; is 5 minutes, &#39;1H&#39;, is one hour. The default is &#39;30T&#39;.</span>
<span class="sd">        stations : list, optional</span>
<span class="sd">            List of station names to use. If None, all present stations will be used. The default is None.</span>
<span class="sd">        startdt : datetime.datetime, optional</span>
<span class="sd">            The start datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        enddt : datetime.datetime, optional</span>
<span class="sd">            The end datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            If True, a diurnal plot is made. The default is True.</span>
<span class="sd">        title : string, optional</span>
<span class="sd">             Title of the figure, if None a default title is generated. The default is None.</span>
<span class="sd">        y_label : string, optional</span>
<span class="sd">             y-axes label of the figure, if None a default label is generated. The default is None.</span>
<span class="sd">        legend : bool, optional</span>
<span class="sd">             I True, a legend is added to the plot. The default is True.</span>
<span class="sd">        errorbands : bool, optional</span>
<span class="sd">            If True, the std is representd in the plot by colored bands. The upper bound represents +1 x std, the lower bound -1 x std. The default is False.</span>
<span class="sd">        show_zero_horizontal : bool, optional</span>
<span class="sd">            If True a horizontal line is drawn in the plot at zero. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame()</span>
<span class="sd">            The dataframe containing the aggregated values.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obsdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">obsdf</span> <span class="o">=</span> <span class="n">obsdf</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># extract refernce from observations</span>
        <span class="n">refdf</span> <span class="o">=</span> <span class="n">obsdf</span><span class="p">[</span><span class="n">obsdf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">refstation</span><span class="p">]</span>
        <span class="n">obsdf</span> <span class="o">=</span> <span class="n">obsdf</span><span class="p">[</span><span class="n">obsdf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">refstation</span><span class="p">]</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">refdf</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Error: No reference observation found (after filtering) for </span><span class="si">{</span><span class="n">refstation</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;Error: No observation found (after filtering)&quot;</span>

        <span class="c1"># Syncronize observations with the reference observations</span>
        <span class="n">refdf</span> <span class="o">=</span> <span class="n">refdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">obstype</span><span class="p">:</span> <span class="s2">&quot;ref_&quot;</span> <span class="o">+</span> <span class="n">obstype</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;ref_datetime&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">obsdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">),</span>
            <span class="n">right</span><span class="o">=</span><span class="n">refdf</span><span class="p">[[</span><span class="s2">&quot;ref_datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;ref_&quot;</span> <span class="o">+</span> <span class="n">obstype</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;ref_datetime&quot;</span><span class="p">),</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;ref_datetime&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">tollerance</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Get differnces</span>
        <span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;ref_temp&quot;</span><span class="p">]</span>

        <span class="c1"># Subset to relavent columns</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">obstype</span><span class="p">]]</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

        <span class="c1"># title</span>
        <span class="n">desc_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">startdt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enddt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle, with </span><span class="si">{</span><span class="n">refstation</span><span class="si">}</span><span class="s2"> as reference,&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle, with </span><span class="si">{</span><span class="n">refstation</span><span class="si">}</span><span class="s2"> as reference, until </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enddt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle, with </span><span class="si">{</span><span class="n">refstation</span><span class="si">}</span><span class="s2"> as reference, from </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hourly average </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> diurnal cycle, with </span><span class="si">{</span><span class="n">refstation</span><span class="si">}</span><span class="s2"> as reference, for period </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># ylabel</span>
        <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (units unknown)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_aggregated_cycle_statistics</span><span class="p">(</span>
            <span class="n">obstype</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span>
            <span class="n">aggregation</span><span class="o">=</span><span class="p">[</span><span class="n">colorby</span><span class="p">],</span>
            <span class="n">aggregation_method</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="n">horizontal_axis</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span>
            <span class="n">startdt</span><span class="o">=</span><span class="n">startdt</span><span class="p">,</span>
            <span class="n">enddt</span><span class="o">=</span><span class="n">enddt</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
            <span class="n">errorbands</span><span class="o">=</span><span class="n">errorbands</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">_return_all_stats</span><span class="p">,</span>
            <span class="n">_obsdf</span><span class="o">=</span><span class="n">mergedf</span><span class="p">,</span>
            <span class="n">_show_zero_line</span><span class="o">=</span><span class="n">show_zero_horizontal</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="Analysis.get_aggregated_cycle_statistics">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.get_aggregated_cycle_statistics.html#metobs_toolkit.analysis.Analysis.get_aggregated_cycle_statistics">[docs]</a>
    <span class="k">def</span> <span class="nf">get_aggregated_cycle_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obstype</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lcz&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
        <span class="n">aggregation_method</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">horizontal_axis</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span>
        <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">startdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enddt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">errorbands</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">_obsdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_show_zero_line</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an average cycle for an aggregated categorie.</span>

<span class="sd">        A commen example is to aggregate to the LCZ&#39;s, so to get the diurnal</span>
<span class="sd">        cycle per LCZ rather than per station.</span>

<span class="sd">        (In the plot, each aggregated category different from datetime, is represed by a line.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obstype : str, optional</span>
<span class="sd">            Element of the metobs_toolkit.observation_types The default is &#39;temp&#39;.</span>
<span class="sd">        aggregation : list, optional</span>
<span class="sd">            List of variables to aggregate to. These variables should either a</span>
<span class="sd">            categorical observation type, a categorical column in the metadf or</span>
<span class="sd">            a time aggregation. All possible time aggreagetions are: [&#39;minute&#39;,</span>
<span class="sd">            &#39;hour&#39;, &#39;month&#39;, &#39;year&#39;, &#39;day_of_year&#39;,</span>
<span class="sd">            &#39;week_of_year&#39;, &#39;season&#39;]. The default is [&#39;lcz&#39;, &#39;datetime&#39;].</span>
<span class="sd">        aggregation_method : str, optional</span>
<span class="sd">            Which (numpy) function is used to aggregate the observations. The default is &#39;mean&#39;.</span>
<span class="sd">        horizontal_axis : str, optional</span>
<span class="sd">            Which aggregated value will be represented on the horizontal axis</span>
<span class="sd">            of the plot. The default is &#39;hour&#39;.</span>
<span class="sd">        stations : list, optional</span>
<span class="sd">            List of station names to use. If None, all present stations will be used. The default is None.</span>
<span class="sd">        startdt : datetime.datetime, optional</span>
<span class="sd">            The start datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        enddt : datetime.datetime, optional</span>
<span class="sd">            The end datetime of the observations to use. If None, all timestamps will be used. The default is None.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            If True, a diurnal plot is made. The default is True.</span>
<span class="sd">        title : string, optional</span>
<span class="sd">             Title of the figure, if None a default title is generated. The default is None.</span>
<span class="sd">        y_label : string, optional</span>
<span class="sd">             y-axes label of the figure, if None a default label is generated. The default is None.</span>
<span class="sd">        legend : bool, optional</span>
<span class="sd">             I True, a legend is added to the plot. The default is True.</span>
<span class="sd">        errorbands : bool, optional</span>
<span class="sd">            If True, the std is representd in the plot by colored bands. The default is False.</span>
<span class="sd">        verbose : True, optional</span>
<span class="sd">            If True, an additional dataframe with aggregation information is returned . The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame()</span>
<span class="sd">            The dataframe containing the aggregated values.</span>

<span class="sd">        Note</span>
<span class="sd">        -------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_obsdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obsdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="n">obstype</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obsdf</span> <span class="o">=</span> <span class="n">_obsdf</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: No observations in the analysis.df: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># Filter stations</span>
        <span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="n">stations</span><span class="p">]</span>

            <span class="n">obsdf</span> <span class="o">=</span> <span class="n">subset_stations</span><span class="p">(</span><span class="n">obsdf</span><span class="p">,</span> <span class="n">stations</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Error: No more observations after subsetting to </span><span class="si">{</span><span class="n">stations</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Filter datetimes</span>
        <span class="n">obsdf</span> <span class="o">=</span> <span class="n">datetime_subsetting</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">obsdf</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="n">startdt</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">enddt</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Error: No more observations after subsetting to </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">startdt</span> <span class="o">=</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">enddt</span> <span class="o">=</span> <span class="n">obsdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># add hour to aggregation (will be the x-axis)</span>
        <span class="k">if</span> <span class="n">horizontal_axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aggregation</span><span class="p">:</span>
            <span class="n">aggregation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">horizontal_axis</span><span class="p">)</span>

        <span class="c1"># add other methods for errorbands and stats</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]</span>
        <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggregation_method</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">methods</span><span class="p">))</span>

        <span class="c1"># compute the aggregation statistics</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">obsdf</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">methods</span><span class="p">)</span>

        <span class="c1"># since only one observation type is in the stats, drop the column</span>
        <span class="c1"># level with the obstye, this is not relevant</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

        <span class="c1"># format dataframe for plotting</span>
        <span class="c1"># Categories to string format</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx_col</span> <span class="ow">in</span> <span class="n">aggdf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx_col</span> <span class="o">==</span> <span class="n">horizontal_axis</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># if numeric, let it be numeric!</span>
            <span class="n">aggdf</span><span class="p">[</span><span class="n">idx_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggdf</span><span class="p">[</span><span class="n">idx_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>

        <span class="c1"># sorting cateigories (months and seisons)</span>

        <span class="n">seasons</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;winter&quot;</span><span class="p">,</span> <span class="s2">&quot;spring&quot;</span><span class="p">,</span> <span class="s2">&quot;summer&quot;</span><span class="p">,</span> <span class="s2">&quot;autumn&quot;</span><span class="p">]</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;January&quot;</span><span class="p">,</span>
            <span class="s2">&quot;February&quot;</span><span class="p">,</span>
            <span class="s2">&quot;March&quot;</span><span class="p">,</span>
            <span class="s2">&quot;April&quot;</span><span class="p">,</span>
            <span class="s2">&quot;May&quot;</span><span class="p">,</span>
            <span class="s2">&quot;June&quot;</span><span class="p">,</span>
            <span class="s2">&quot;July&quot;</span><span class="p">,</span>
            <span class="s2">&quot;August&quot;</span><span class="p">,</span>
            <span class="s2">&quot;September&quot;</span><span class="p">,</span>
            <span class="s2">&quot;October&quot;</span><span class="p">,</span>
            <span class="s2">&quot;November&quot;</span><span class="p">,</span>
            <span class="s2">&quot;December&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">season_order_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">months_order_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seasons</span><span class="p">):</span>
            <span class="n">season_order_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">months</span><span class="p">):</span>
            <span class="n">months_order_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># Sort columns</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">sort_list</span> <span class="o">=</span> <span class="n">aggregation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;season&quot;</span> <span class="ow">in</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">aggdf</span><span class="p">[</span><span class="s2">&quot;season_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggdf</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">season_order_dict</span><span class="p">)</span>
            <span class="n">sort_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;season_num&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;season&quot;</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sort_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">aggdf</span><span class="p">[</span><span class="s2">&quot;month_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggdf</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">months_order_dict</span><span class="p">)</span>
            <span class="n">sort_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;month_num&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sort_list</span><span class="p">]</span>
        <span class="c1"># sort dataframe</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># drop dummy num coluns (if they are present)</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;season_num&quot;</span><span class="p">,</span> <span class="s2">&quot;month_num&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="c1"># reset the index</span>
        <span class="n">aggdf</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>

        <span class="c1"># unstack aggregation</span>
        <span class="n">aggregation</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">horizontal_axis</span><span class="p">)</span>  <span class="c1"># let horizontal axes be the index</span>
        <span class="n">all_stats</span> <span class="o">=</span> <span class="n">aggdf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span>  <span class="c1"># return on verbose</span>

        <span class="c1"># Sort index if categorical</span>
        <span class="k">if</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;season&quot;</span><span class="p">:</span>
            <span class="n">all_stats</span> <span class="o">=</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">seasons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span>
            <span class="n">all_stats</span> <span class="o">=</span> <span class="n">all_stats</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>

        <span class="c1"># split in values and std</span>
        <span class="n">values_df</span> <span class="o">=</span> <span class="n">all_stats</span><span class="p">[</span><span class="n">aggregation_method</span><span class="p">]</span>
        <span class="n">std_df</span> <span class="o">=</span> <span class="n">all_stats</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>

        <span class="c1"># make shure all data is numeric</span>
        <span class="n">values_df</span> <span class="o">=</span> <span class="n">values_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">std_df</span> <span class="o">=</span> <span class="n">std_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># squize all column levels to one category for plotting</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aggregation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># more than one level for the columns</span>
            <span class="n">values_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot; ,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">values_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
            <span class="p">]</span>
            <span class="n">std_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; ,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">std_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># description of the obstype</span>
            <span class="n">desc_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
                <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obstype</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

            <span class="c1"># generate title</span>
            <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">startdtstr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="n">startdt</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;print_fmt_datetime&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">enddtstr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="n">enddt</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;print_fmt_datetime&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aggregation_method</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">horizontal_axis</span><span class="w"> </span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> cycle for period </span><span class="si">{</span><span class="n">startdtstr</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">enddtstr</span><span class="si">}</span><span class="s2"> grouped by </span><span class="si">{</span><span class="n">aggregation</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># ylabel</span>
            <span class="k">if</span> <span class="n">y_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc_dict</span><span class="p">:</span>
                    <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (units unknown)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">desc_dict</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

            <span class="c1"># generate errorbands df</span>
            <span class="k">if</span> <span class="n">errorbands</span><span class="p">:</span>
                <span class="n">stddf</span> <span class="o">=</span> <span class="n">std_df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stddf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Make plot</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">cycle_plot</span><span class="p">(</span>
                <span class="n">cycledf</span><span class="o">=</span><span class="n">values_df</span><span class="p">,</span>
                <span class="n">errorbandsdf</span><span class="o">=</span><span class="n">stddf</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">plot_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;plot_settings&quot;</span><span class="p">][</span><span class="s2">&quot;diurnal&quot;</span><span class="p">],</span>
                <span class="n">aggregation</span><span class="o">=</span><span class="n">aggregation</span><span class="p">,</span>
                <span class="n">data_template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_template</span><span class="p">,</span>
                <span class="n">obstype</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
                <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                <span class="n">show_zero_horizontal</span><span class="o">=</span><span class="n">_show_zero_line</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">horizontal_axis</span> <span class="o">==</span> <span class="s2">&quot;hour&quot;</span><span class="p">:</span>
                <span class="c1"># extract timezone</span>
                <span class="n">tzstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{x:.0f}</span><span class="s2"> h&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hours (timezone: </span><span class="si">{</span><span class="n">tzstring</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">values_df</span><span class="p">,</span> <span class="n">all_stats</span><span class="p">,</span> <span class="n">ax</span>
            <span class="k">return</span> <span class="n">values_df</span><span class="p">,</span> <span class="n">all_stats</span>

        <span class="k">return</span> <span class="n">values_df</span></div>


    <span class="c1"># =============================================================================</span>
    <span class="c1"># Correlations analysis</span>
    <span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Analysis.get_lc_correlation_matrices">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.get_lc_correlation_matrices.html#metobs_toolkit.analysis.Analysis.get_lc_correlation_matrices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lc_correlation_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obstype</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">],</span> <span class="n">groupby_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute pearson correlation coeficients.</span>

<span class="sd">        A method to compute the Pearson correlation between an obervation type</span>
<span class="sd">        and present landcover fractions in the metadf.</span>

<span class="sd">        The correlations are computed per group as defined by unique combinations</span>
<span class="sd">        of the groupby_labels.</span>

<span class="sd">        A dictionary is returnd where each key represents a unique combination of</span>
<span class="sd">        the groupby_labels. The value is a dictionary with the following keys</span>
<span class="sd">        and values:</span>

<span class="sd">        * cor matrix: the Pearson correlation matrix</span>
<span class="sd">        * significance matrix: the significance (p-)values of the correlations.</span>
<span class="sd">        * combined matrix: A human readable combination of the correlations and their p values. Indicate by \*, \*\* or \*\*\* representing p-values &lt; 0.05, 0.01 and 0.001 respectively.</span>

<span class="sd">        This dictionary is also stored as a lc_cor_dict attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obstype : str, or list optional</span>
<span class="sd">            The observation type(s) to compute the correlations on. The default is [&#39;temp&#39;].</span>
<span class="sd">        groupby_labels : list, optional</span>
<span class="sd">            List of variables to form one group, resulting in one correlation.</span>
<span class="sd">            These variables should either a categorical observation type, a categorical column in the metadf or</span>
<span class="sd">            a time aggregation. All possible time aggreagetions are: [&#39;minute&#39;,</span>
<span class="sd">            &#39;hour&#39;, &#39;month&#39;, &#39;year&#39;, &#39;day_of_year&#39;,</span>
<span class="sd">            &#39;week_of_year&#39;, &#39;season&#39;]. The default is [&#39;hour&#39;].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cor_dict : dict</span>
<span class="sd">            A nested dictionary with unique combinations of groupby values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obstype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">obstype</span> <span class="o">=</span> <span class="p">[</span><span class="n">obstype</span><span class="p">]</span>

        <span class="c1"># get data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">_make_time_derivatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby_labels</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_lab</span> <span class="ow">in</span> <span class="n">groupby_labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_lab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[[</span><span class="n">group_lab</span><span class="p">]],</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
                    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">group_lab</span> <span class="ow">in</span> <span class="n">groupby_labels</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">group_lab</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">group_lab</span><span class="si">}</span><span class="s1">&quot; is found in the observations of possible groupby_labels.&#39;</span>

        <span class="c1"># subset columns</span>
        <span class="n">relev_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">groupby_labels</span><span class="p">]</span>  <span class="c1"># to avoid deep copy import</span>
        <span class="n">relev_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">relev_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obstype</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">relev_columns</span><span class="p">]</span>

        <span class="c1"># find landcover columnnames in the metadf</span>
        <span class="n">lc_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">((</span><span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)))</span>
        <span class="p">]</span>

        <span class="c1"># get landcover data</span>
        <span class="n">lc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="n">lc_columns</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">lc_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No landcover columns found in the metadf. Landcover correlations cannot be computed.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># merge together</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">lc_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># remove name column if it is not explicit in the groupby labels</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby_labels</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

        <span class="c1"># create return</span>
        <span class="n">cor_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Iterate over all groups</span>

        <span class="c1"># avoid futur pandas warning for groupby labels of len==1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_labels</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_lab</span><span class="p">,</span> <span class="n">groupdf</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># No correlations can be computed when no variance is found</span>
            <span class="k">if</span> <span class="n">groupdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No variance found in correlationd group </span><span class="si">{</span><span class="n">group_lab</span><span class="si">}</span><span class="s2">. Correlation thus not be computed for this group: </span><span class="si">{</span><span class="n">groupdf</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># drop groupby labels</span>
            <span class="n">groupdf</span> <span class="o">=</span> <span class="n">groupdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">groupby_labels</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

            <span class="n">rho</span> <span class="o">=</span> <span class="n">groupdf</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">)</span>
            <span class="n">pval</span> <span class="o">=</span> <span class="n">groupdf</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span>
                <span class="o">*</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>
            <span class="c1"># represent p values by stars</span>
            <span class="n">p_stars</span> <span class="o">=</span> <span class="n">pval</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;*&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># combined human readable df</span>
            <span class="n">comb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rho</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rho</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">comb_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">rho</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.02f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">p_stars</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">cor_dict</span><span class="p">[</span><span class="n">group_lab</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cor matrix&quot;</span><span class="p">:</span> <span class="n">rho</span><span class="p">,</span>
                <span class="s2">&quot;significance matrix&quot;</span><span class="p">:</span> <span class="n">pval</span><span class="p">,</span>
                <span class="s2">&quot;combined matrix&quot;</span><span class="p">:</span> <span class="n">comb_df</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Update attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span> <span class="o">=</span> <span class="n">cor_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lc_cor_obstype</span> <span class="o">=</span> <span class="n">obstype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span> <span class="o">=</span> <span class="n">groupby_labels</span>

        <span class="k">return</span> <span class="n">cor_dict</span></div>


<div class="viewcode-block" id="Analysis.plot_correlation_heatmap">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.plot_correlation_heatmap.html#metobs_toolkit.analysis.Analysis.plot_correlation_heatmap">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_correlation_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">groupby_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_return_ax</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a heatmap plot af a correaltion matrix.</span>

<span class="sd">        To specify which correlation matrix to plot, specify the group value</span>
<span class="sd">        using the groupby_value argument.</span>

<span class="sd">        All possible groupby_values are the keys of the lc_cor_dict attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        groupby_value : str, num, None, optional</span>
<span class="sd">            A groupby value to indicate which correlation matrix to visualise.</span>
<span class="sd">            If None is given, the first groupby value that is present is</span>
<span class="sd">            chosen.The default is None.</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Title of the figure. If None, a default title is constructed.The</span>
<span class="sd">            default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>
<span class="sd">        To list all possible groupby_values, one can use</span>
<span class="sd">        ` print(Analysis_instance.lc_cor_dict.keys())`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if there are correlation matrices</span>
        <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span>
        <span class="p">),</span> <span class="s2">&quot;No correlation matrices found, use the metod get_lc_correlation_matrices first.&quot;</span>

        <span class="k">if</span> <span class="n">groupby_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groupby_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No groupby_value is given, so the first groupby value (=</span><span class="si">{groupby_value}</span><span class="s2">) will be used!&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The correlations are computed over </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span><span class="si">}</span><span class="s2"> with the following unique values: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># check if groupby value exists</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">groupby_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">groupby_value</span><span class="si">}</span><span class="s2"> not found as a groupby value. These are all the possible values: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Correlation heatmap for group: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">groupby_value</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">heatmap_plot</span><span class="p">(</span>
            <span class="n">cor_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="p">[</span><span class="n">groupby_value</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">heatmap_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;plot_settings&quot;</span><span class="p">][</span><span class="s2">&quot;correlation_heatmap&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">_return_ax</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="Analysis.plot_correlation_variation">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.analysis.Analysis.plot_correlation_variation.html#metobs_toolkit.analysis.Analysis.plot_correlation_variation">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_correlation_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create correlation scatter plot.</span>

<span class="sd">        Make a scatter plot of the correlations to visualise differences between</span>
<span class="sd">        multiple group values.</span>

<span class="sd">        Group values are represented by the horizontal axes, and correlations</span>
<span class="sd">        on the vertical axe.</span>

<span class="sd">        All correlations, that are not constant, are plotted as scatters with</span>
<span class="sd">        unique colors.</span>

<span class="sd">        The scatter marker indicates the p-value of the correlations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Title of the figure. If None, a default title is constructed. The</span>
<span class="sd">            default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>
<span class="sd">        If to many possible group values exist, one can use the apply_filter()</span>
<span class="sd">        method to reduce the group values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if there are correlation matrices</span>
        <span class="k">assert</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span>
        <span class="p">),</span> <span class="s2">&quot;No correlation matrices found, use the metod get_lc_correlation_matrices first.&quot;</span>

        <span class="c1"># check if correlation evolution information is available</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Only one correlation group is found: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The variance plot can not be made.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Correlation scatter for group: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">correlation_scatter</span><span class="p">(</span>
            <span class="n">full_cor_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lc_cor_dict</span><span class="p">,</span>
            <span class="n">groupby_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_groupby_labels</span><span class="p">,</span>
            <span class="n">obstypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lc_cor_obstype</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">cor_scatter_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;plot_settings&quot;</span><span class="p">][</span>
                <span class="s2">&quot;correlation_scatter&quot;</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>
</div>



<span class="k">def</span> <span class="nf">_make_time_derivatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">required</span><span class="p">,</span> <span class="n">get_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct time derivated columns if required.</span>

<span class="sd">    datetime must be a column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;minute&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;minute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;year&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;day_of_year&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_year</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;week_of_year&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;week_of_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="s2">&quot;week&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;season&quot;</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">get_all</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;season&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_seasons</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">get_seasons</span><span class="p">(</span>
    <span class="n">datetimeseries</span><span class="p">,</span>
    <span class="n">start_day_spring</span><span class="o">=</span><span class="s2">&quot;01/03&quot;</span><span class="p">,</span>
    <span class="n">start_day_summer</span><span class="o">=</span><span class="s2">&quot;01/06&quot;</span><span class="p">,</span>
    <span class="n">start_day_autumn</span><span class="o">=</span><span class="s2">&quot;01/09&quot;</span><span class="p">,</span>
    <span class="n">start_day_winter</span><span class="o">=</span><span class="s2">&quot;01/12&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a datetimeseries to a season label (i.g. categorical).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datetimeseries : datetime.datetime</span>
<span class="sd">        The timeseries that you want to split up in seasons.</span>
<span class="sd">    start_day_spring : str , optional</span>
<span class="sd">        Start date for spring, default is &#39;01/03&#39; and if changed the input</span>
<span class="sd">        should have the same format as the default value.</span>
<span class="sd">    start_day_summer : str , optional</span>
<span class="sd">        Start date for summer, default is &#39;01/06&#39; and if changed the input</span>
<span class="sd">        should have the same format as the default value.</span>
<span class="sd">    start_day_autumn : str , optional</span>
<span class="sd">        Start date for autumn, default is &#39;01/09&#39; and if changed the input</span>
<span class="sd">        should have the same format as the default value.</span>
<span class="sd">    start_day_winter : str , optional</span>
<span class="sd">        Start date for winter, default is &#39;01/12&#39; and if changed the input</span>
<span class="sd">        should have the same format as the default value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : dataframe</span>
<span class="sd">        A obtained dataframe that has where a label for the seasons has been added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spring_startday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_day_spring</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m&quot;</span><span class="p">)</span>
    <span class="n">summer_startday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_day_summer</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m&quot;</span><span class="p">)</span>
    <span class="n">autumn_startday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_day_autumn</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m&quot;</span><span class="p">)</span>
    <span class="n">winter_startday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_day_winter</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m&quot;</span><span class="p">)</span>

    <span class="n">seasons</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spring&quot;</span><span class="p">,</span> <span class="s2">&quot;summer&quot;</span><span class="p">,</span> <span class="s2">&quot;autumn&quot;</span><span class="p">,</span> <span class="s2">&quot;winter&quot;</span><span class="p">],</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">spring_startday</span><span class="p">,</span> <span class="n">summer_startday</span><span class="p">,</span> <span class="n">autumn_startday</span><span class="p">,</span> <span class="n">winter_startday</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;startdt&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="n">seasons</span><span class="p">[</span><span class="s2">&quot;day_of_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seasons</span><span class="p">[</span><span class="s2">&quot;startdt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_year</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">seasons</span><span class="p">[</span><span class="s2">&quot;day_of_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="n">bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">366</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;winter&quot;</span><span class="p">,</span> <span class="s2">&quot;spring&quot;</span><span class="p">,</span> <span class="s2">&quot;summer&quot;</span><span class="p">,</span> <span class="s2">&quot;autumn&quot;</span><span class="p">,</span> <span class="s2">&quot;winter&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">datetimeseries</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metadf</span><span class="p">,</span> <span class="n">quarry_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a dataframe by a user definde string expression.</span>

<span class="sd">    This can be used to filter the observation to specific meteorological</span>
<span class="sd">    conditions (i.e. low windspeeds, high humidity, cold temperatures, ...)</span>

<span class="sd">    The filter expression contains only columns present in the df and/or the</span>
<span class="sd">    metadf.</span>

<span class="sd">    The filtered df and metadf are returned</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataframe containing all the observations to be filterd.</span>
<span class="sd">    metadf : pandas.DataFrame</span>
<span class="sd">        The dataframe containig all the metadata per station.</span>
<span class="sd">    quarry_str : str</span>
<span class="sd">        A filter expression using columnnames present in either df or metadf.</span>
<span class="sd">        The following timestamp derivatives can be used as well: [minute, hour,</span>
<span class="sd">        month, year, day_of_year, week_of_year, season]. The quarry_str may</span>
<span class="sd">        contain number and expressions like &lt;, &gt;, ==, &gt;=, \*, +, .... Multiple filters</span>
<span class="sd">        can be combine to one expression by using &amp; (AND) and | (OR).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    filter_df : pandas.DataFrame</span>
<span class="sd">        The filtered df.</span>
<span class="sd">    filter_metadf : pandas.DataFrame</span>
<span class="sd">        The filtered metadf.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># save index order and names for reconstruction</span>
    <span class="n">df_init_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="n">metadf_init_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

    <span class="c1"># easyer for sperationg them</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># save columns orders</span>
    <span class="n">df_init_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">metadf_init_cols</span> <span class="o">=</span> <span class="n">metadf</span><span class="o">.</span><span class="n">columns</span>

    <span class="c1"># create time derivative columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">_make_time_derivatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">get_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># merge together on name</span>
    <span class="n">mergedf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">metadf</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

    <span class="c1"># apply filter</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">quarry_str</span><span class="p">)</span>

    <span class="c1"># split to df and metadf</span>
    <span class="n">filter_df</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="n">df_init_cols</span><span class="p">]</span>
    <span class="n">filter_metadf</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="n">metadf_init_cols</span><span class="p">]</span>

    <span class="c1"># set indexes</span>
    <span class="n">filter_df</span> <span class="o">=</span> <span class="n">filter_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">df_init_idx</span><span class="p">)</span>
    <span class="n">filter_metadf</span> <span class="o">=</span> <span class="n">filter_metadf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">metadf_init_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filter_df</span><span class="p">,</span> <span class="n">filter_metadf</span>
</pre></div>

                </article>





                <footer class="prev-next-footer">

<div class="prev-next-area">
</div>
                </footer>

            </div>



                <div class="bd-sidebar-secondary bd-toc"></div>


          </div>
          <footer class="bd-footer-content">

          </footer>

      </main>
    </div>
  </div>

  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">

    <div class="footer-items__start">

        <div class="footer-item">

  <p class="copyright">

       Copyright 2023, Thomas Vergauwen.
      <br/>

  </p>
</div>

        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>

    </div>



    <div class="footer-items__end">

        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>

    </div>

</div>

  </footer>
  </body>
</html>
