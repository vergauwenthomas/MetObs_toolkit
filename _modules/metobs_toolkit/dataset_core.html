
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>metobs_toolkit.dataset_core &#8212; MetObs Toolkit documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=643eef25" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/metobs_toolkit/dataset_core';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo_small.svg" class="logo__image only-light" alt="MetObs Toolkit documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo_small.svg" class="logo__image only-dark" alt="MetObs Toolkit documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../specific_topics.html">
    Specific topics
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../MetObs_documentation_flat.html">
    Documentation
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../topics/contributing_link.html">
    Contributing
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/vergauwenthomas/MetObs_toolkit" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-xl fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../index.html">
    Home
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro.html">
    Getting started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../specific_topics.html">
    Specific topics
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../examples/index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../MetObs_documentation_flat.html">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../topics/contributing_link.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/vergauwenthomas/MetObs_toolkit" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-xl fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">metobs_toolk...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for metobs_toolkit.dataset_core</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the Dataset class and all its methods.</span>

<span class="sd">A Dataset holds all observations and is at the center of the</span>
<span class="sd">MetObs-toolkit.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.settings</span> <span class="kn">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.data_import</span> <span class="kn">import</span> <span class="n">import_data_from_csv</span><span class="p">,</span> <span class="n">import_metadata_from_csv</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.template</span> <span class="kn">import</span> <span class="n">Template</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.printing</span> <span class="kn">import</span> <span class="n">print_dataset_info</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.landcover_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">connect_to_gee</span><span class="p">,</span>
    <span class="n">lcz_extractor</span><span class="p">,</span>
    <span class="n">height_extractor</span><span class="p">,</span>
    <span class="n">lc_fractions_extractor</span><span class="p">,</span>
    <span class="n">_validate_metadf</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># from metobs_toolkit.plotting_functions import (</span>
<span class="c1">#     geospatial_plot,</span>
<span class="c1">#     timeseries_plot,</span>
<span class="c1">#     # qc_stats_pie,</span>
<span class="c1">#     folium_plot,</span>
<span class="c1">#     add_stations_to_folium_map,</span>
<span class="c1">#     make_folium_html_plot,</span>
<span class="c1"># )</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.qc_checks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="c1"># gross_value_check,</span>
    <span class="c1"># persistance_check,</span>
    <span class="c1"># repetitions_check,</span>
    <span class="n">duplicate_timestamp_check</span><span class="p">,</span>
    <span class="c1">#     step_check,</span>
    <span class="c1">#     window_variation_check,</span>
    <span class="n">invalid_input_check</span><span class="p">,</span>
    <span class="c1">#     toolkit_buddy_check,</span>
    <span class="c1">#     titan_buddy_check,</span>
    <span class="c1">#     titan_sct_resistant_check,</span>
<span class="p">)</span>


<span class="c1"># from metobs_toolkit.qc_statistics import get_freq_statistics</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.writing_files</span> <span class="kn">import</span> <span class="n">write_dataset_to_csv</span>

<span class="c1"># from metobs_toolkit.missingobs import Missingob_collection</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.gap</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="c1"># Gap,</span>
    <span class="n">remove_gaps_from_obs</span><span class="p">,</span>
    <span class="c1"># remove_gaps_from_outliers,</span>
    <span class="n">missing_timestamp_and_gap_check</span><span class="p">,</span>
    <span class="n">get_gaps_indx_in_obs_space</span><span class="p">,</span>
    <span class="n">get_station_gaps</span><span class="p">,</span>
    <span class="c1"># apply_interpolate_gaps,</span>
    <span class="c1"># make_gapfill_df,</span>
    <span class="c1"># apply_debias_era5_gapfill,</span>
    <span class="c1"># gaps_to_df,</span>
<span class="p">)</span>


<span class="kn">from</span> <span class="nn">metobs_toolkit.df_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="c1"># multiindexdf_datetime_subsetting,</span>
    <span class="n">fmt_datetime_argument</span><span class="p">,</span>
    <span class="c1"># init_multiindex,</span>
    <span class="n">init_multiindexdf</span><span class="p">,</span>
    <span class="n">init_triple_multiindexdf</span><span class="p">,</span>
    <span class="n">metadf_to_gdf</span><span class="p">,</span>
    <span class="n">conv_applied_qc_to_df</span><span class="p">,</span>
    <span class="n">get_freqency_series</span><span class="p">,</span>
    <span class="n">value_labeled_doubleidxdf_to_triple_idxdf</span><span class="p">,</span>
    <span class="n">xs_save</span><span class="p">,</span>
    <span class="n">concat_save</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">metobs_toolkit.obstypes</span> <span class="kn">import</span> <span class="n">tlk_obstypes</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.obstypes</span> <span class="kn">import</span> <span class="n">Obstype</span> <span class="k">as</span> <span class="n">Obstype_class</span>


<span class="kn">from</span> <span class="nn">metobs_toolkit.analysis</span> <span class="kn">import</span> <span class="n">Analysis</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.modeldata</span> <span class="kn">import</span> <span class="n">Modeldata</span>
<span class="kn">from</span> <span class="nn">metobs_toolkit.datasetbase</span> <span class="kn">import</span> <span class="n">_DatasetBase</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Dataset class</span>
<span class="c1"># =============================================================================</span>


<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">_DatasetBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Objects holding observations and methods on observations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Dataset.__init__">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.html#metobs_toolkit.Dataset.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct all the necessary attributes for Dataset object.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initialise dataset&quot;</span><span class="p">)</span>

        <span class="n">_DatasetBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># holds df, metadf, obstypes and settings</span>

        <span class="c1"># Dataset with outlier observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="n">init_triple_multiindexdf</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># becomes a Missingob_collection after import</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># becomes a list of gaps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gapfilldf</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_df</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>

        <span class="c1"># Template for mapping data and metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_istype</span> <span class="o">=</span> <span class="s2">&quot;Dataset&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freqs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="s2">&quot;checkname&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qc_checked_obstypes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list with qc-checked obstypes</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represent as text.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istype</span> <span class="o">==</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Empty instance of a Dataset.&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_istype</span> <span class="o">==</span> <span class="s2">&quot;Station&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Empty instance of a Station.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Empty instance of a Analysis.&quot;</span>

        <span class="n">add_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">n_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_obs_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_outl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">startdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">enddt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">add_info</span> <span class="o">+=</span> <span class="s2">&quot;    *Coordinates are available for all stations.&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_istype</span><span class="si">}</span><span class="s2"> instance containing: </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="n">n_stations</span><span class="si">}</span><span class="s2"> stations </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s2"> observation types </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="n">n_obs_tot</span><span class="si">}</span><span class="s2"> observation records </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="n">n_outl</span><span class="si">}</span><span class="s2"> records labeled as outliers </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">)</span><span class="si">}</span><span class="s2"> gaps </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> missing observations </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *records range: </span><span class="si">{</span><span class="n">startdt</span><span class="si">}</span><span class="s2"> --&gt; </span><span class="si">{</span><span class="n">enddt</span><span class="si">}</span><span class="s2"> (total duration:  </span><span class="si">{</span><span class="n">enddt</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startdt</span><span class="si">}</span><span class="s2">) </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">    *time zone of the records: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;</span>
            <span class="o">+</span> <span class="n">add_info</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Info representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">gapsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Addition of two Datasets.&quot;&quot;&quot;</span>
        <span class="c1"># important !!!!!</span>

        <span class="c1"># the toolkit makes a new dataframe, and assumes the df from self and other</span>
        <span class="c1"># to be the input data.</span>
        <span class="c1"># This means that missing obs, gaps, invalid and duplicated records are</span>
        <span class="c1"># being looked for in the concatenation of both dataset, using their current</span>
        <span class="c1"># resolution !</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="n">self_obstypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#  ---- df ----</span>

        <span class="c1"># check if observation of self are also in other</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([(</span><span class="n">obs</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">self_obstypes</span><span class="p">])</span>
        <span class="c1"># subset obstype of other to self</span>
        <span class="n">other</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>

        <span class="c1"># remove duplicate rows</span>
        <span class="n">common_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">other</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">common_indexes</span><span class="p">)</span>

        <span class="c1"># set new df</span>
        <span class="n">new</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1">#  ----- outliers df ---------</span>

        <span class="n">other_outliers</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">other_outliers</span> <span class="o">=</span> <span class="n">other_outliers</span><span class="p">[</span><span class="n">other_outliers</span><span class="p">[</span><span class="s2">&quot;obstype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">self_obstypes</span><span class="p">)]</span>
        <span class="n">other_outliers</span> <span class="o">=</span> <span class="n">other_outliers</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="p">,</span> <span class="n">other_outliers</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1">#  ------- Gaps -------------</span>
        <span class="c1"># Gaps have to be recaluculated using a frequency assumtion from the</span>
        <span class="c1"># combination of self.df and other.df, thus NOT the native frequency if</span>
        <span class="c1"># their is a coarsening allied on either of them.</span>
        <span class="n">new</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ---------- missing ---------</span>
        <span class="c1"># Missing observations have to be recaluculated using a frequency assumtion from the</span>
        <span class="c1"># combination of self.df and other.df, thus NOT the native frequency if</span>
        <span class="c1"># their is a coarsening allied on either of them.</span>
        <span class="n">new</span><span class="o">.</span><span class="n">missing_obs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ---------- metadf -----------</span>
        <span class="c1"># Use the metadf from self and add new rows if they are present in other</span>
        <span class="n">new</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">metadf</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1"># ------- specific attributes ----------</span>

        <span class="c1"># Template (units and descritpions) are taken from self</span>
        <span class="n">new</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>

        <span class="c1"># Inherit Settings from self</span>
        <span class="n">new</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>

        <span class="c1"># Applied qc:</span>
        <span class="c1"># TODO:  is this oke to do?</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_applied_qc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="s2">&quot;checkname&quot;</span><span class="p">])</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_qc_checked_obstypes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list with qc-checked obstypes</span>

        <span class="c1"># set init_dataframe to empty</span>
        <span class="c1"># NOTE: this is not necesarry but users will use this method when they</span>
        <span class="c1"># have a datafile that is to big. So storing and overloading a copy of</span>
        <span class="c1"># the very big datafile is invalid for these cases.</span>
        <span class="n">new</span><span class="o">.</span><span class="n">input_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># ----- Apply IO QC ---------</span>
        <span class="c1"># Apply only checks that are relevant on records in between self and other</span>
        <span class="c1"># OR</span>
        <span class="c1"># that are dependand on the frequency (since the freq of the .df is used,</span>
        <span class="c1"># which is not the naitive frequency if coarsening is applied on either. )</span>

        <span class="c1"># missing and gap check</span>
        <span class="k">if</span> <span class="n">gapsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gapsize</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_settings&quot;</span><span class="p">][</span><span class="s2">&quot;gaps_finder&quot;</span><span class="p">][</span><span class="s2">&quot;gapsize_n&quot;</span><span class="p">]</span>

        <span class="c1"># note gapsize is now defined on the frequency of self</span>
        <span class="n">new</span><span class="o">.</span><span class="n">missing_obs</span><span class="p">,</span> <span class="n">new</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="n">missing_timestamp_and_gap_check</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">new</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">gapsize_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_settings&quot;</span><span class="p">][</span><span class="s2">&quot;gaps_finder&quot;</span><span class="p">][</span><span class="s2">&quot;gapsize_n&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># duplicate check</span>
        <span class="n">new</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">dup_outl_df</span> <span class="o">=</span> <span class="n">duplicate_timestamp_check</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">new</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">checks_info</span><span class="o">=</span><span class="n">new</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_checks_info&quot;</span><span class="p">],</span>
            <span class="n">checks_settings</span><span class="o">=</span><span class="n">new</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_check_settings&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dup_outl_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">update_outliersdf</span><span class="p">(</span><span class="n">add_to_outliersdf</span><span class="o">=</span><span class="n">dup_outl_df</span><span class="p">)</span>

        <span class="c1"># update the order and which qc is applied on which obstype</span>
        <span class="n">checked_obstypes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">checknames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;duplicated_timestamp&quot;</span><span class="p">]</span>  <span class="c1"># KEEP order</span>

        <span class="n">new</span><span class="o">.</span><span class="n">_applied_qc</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">new</span><span class="o">.</span><span class="n">_applied_qc</span><span class="p">,</span>
                <span class="n">conv_applied_qc_to_df</span><span class="p">(</span>
                    <span class="n">obstypes</span><span class="o">=</span><span class="n">checked_obstypes</span><span class="p">,</span> <span class="n">ordered_checknames</span><span class="o">=</span><span class="n">checknames</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new</span>

<div class="viewcode-block" id="Dataset.show">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.show.html#metobs_toolkit.Dataset.show">[docs]</a>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_all_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_disp_n_gaps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show detailed information of the Dataset.</span>

<span class="sd">        A function to print out a detailed overview information about the Dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_all_settings : bool, optional</span>
<span class="sd">            If True all the settings are printed out. The default is False.</span>
<span class="sd">        max_disp_n_gaps: int, optional</span>
<span class="sd">            The maximum number of gaps to display detailed information of.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Create your Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset() #empty Dataset</span>

<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Add observations to the Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Print out details</span>
<span class="sd">            &gt;&gt;&gt; dataset.show()</span>
<span class="sd">            --------  General ---------</span>
<span class="sd">            ...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Show basic info of dataset.&quot;</span><span class="p">)</span>

        <span class="n">print_dataset_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_all_settings</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.get_info">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_info.html#metobs_toolkit.Dataset.get_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_all_settings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_disp_n_gaps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias of show().</span>

<span class="sd">        A function to print out a detailed overview information about the Dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_all_settings : bool, optional</span>
<span class="sd">            If True all the settings are printed out. The default is False.</span>
<span class="sd">        max_disp_n_gaps: int, optional</span>
<span class="sd">            The maximum number of gaps to display detailed information of.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Create your Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset() #empty Dataset</span>

<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Add observations to the Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Print out details</span>
<span class="sd">            &gt;&gt;&gt; dataset.get_info()</span>
<span class="sd">            --------  General ---------</span>
<span class="sd">            ...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">show_all_settings</span><span class="p">,</span> <span class="n">max_disp_n_gaps</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.save_dataset">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.save_dataset.html#metobs_toolkit.Dataset.save_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">save_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">outputfolder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;saved_dataset.pkl&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a Dataset instance to a (pickle) file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        outputfolder : str or None, optional</span>
<span class="sd">            The path to the folder to save the file. If None, the outputfolder</span>
<span class="sd">            from the Settings is used. The default is None.</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            The name of the output file. The default is &#39;saved_dataset.pkl&#39;.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If True, the target file will be overwritten if it exist. The</span>
<span class="sd">            default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...            input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...            input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...            template_file=metobs_toolkit.demo_template)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Save dataset to a .pkl file</span>
<span class="sd">            &gt;&gt;&gt; dataset.save_dataset(outputfolder=os.getcwd(),</span>
<span class="sd">            ...                     filename=&#39;your_saved_dataset.pkl&#39;,</span>
<span class="sd">            ...                     overwrite=True)</span>
<span class="sd">            Dataset saved in ...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if outputfolder is known and exists</span>
        <span class="k">if</span> <span class="n">outputfolder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">outputfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="s2">&quot;No outputfolder is given, and no outputfolder is found in the settings.&quot;</span>

        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outputfolder</span><span class="si">}</span><span class="s2"> is not a directory!&quot;</span>

        <span class="c1"># check file extension in the filename:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.pkl&quot;</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> will be overwritten!&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>

        <span class="c1"># check if file exists</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> is already a file!&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outp</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outp</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset saved in </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset saved in </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.import_dataset">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.import_dataset.html#metobs_toolkit.Dataset.import_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">import_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;saved_dataset.pkl&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import a Dataset instance from a (pickle) file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder_path : str or None, optional</span>
<span class="sd">            The path to the folder to save the file. If None, the outputfolder</span>
<span class="sd">            from the Settings is used. The default is None.</span>
<span class="sd">        filename : str, optional</span>
<span class="sd">            The name of the output file. The default is &#39;saved_dataset.pkl&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        metobs_toolkit.Dataset</span>
<span class="sd">            The Dataset instance.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            import metobs_toolkit</span>
<span class="sd">            import os</span>

<span class="sd">            # Initialize an empty Dataset</span>
<span class="sd">            empty_dataset = metobs_toolkit.Dataset()</span>

<span class="sd">            # Import the dataset</span>
<span class="sd">            dataset=empty_dataset.import_dataset(folder_path=os.getcwd(),</span>
<span class="sd">                                                 filename=&#39;your_saved_dataset.pkl&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if folder_path is known and exists</span>
        <span class="k">if</span> <span class="n">folder_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">folder_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="s2">&quot;No folder_path is given, and no outputfolder is found in the settings.&quot;</span>

        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2"> is not a directory!&quot;</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># check if file exists</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="c1"># convert metadf to a geodataframe (if coordinates are available)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf_to_gdf</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">metadf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="Dataset.add_new_observationtype">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.add_new_observationtype.html#metobs_toolkit.Dataset.add_new_observationtype">[docs]</a>
    <span class="k">def</span> <span class="nf">add_new_observationtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Obstype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new observation type to the known observation types.</span>

<span class="sd">        The observation can only be added if it is not already present in the</span>
<span class="sd">        knonw observation types. If that is the case that you probably need to</span>
<span class="sd">        use use the Dataset.add_new_unit() method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">            The new Obstype to add.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt; co2_concentration = metobs_toolkit.Obstype(obsname=&#39;co2&#39;,</span>
<span class="sd">            ...                                            std_unit=&#39;ppm&#39;)</span>
<span class="sd">            &gt;&gt;&gt; #add other units to it (if needed)</span>
<span class="sd">            &gt;&gt;&gt; co2_concentration.add_unit(unit_name=&#39;ppb&#39;,</span>
<span class="sd">            ...                            conversion=[&#39;x / 1000&#39;], #1 ppb = 0.001 ppm</span>
<span class="sd">            ...                           )</span>
<span class="sd">            &gt;&gt;&gt; #Set a description</span>
<span class="sd">            &gt;&gt;&gt; co2_concentration.set_description(desc=&#39;The CO2 concentration measured at 2m above surface&#39;)</span>
<span class="sd">            &gt;&gt;&gt; #Add it to a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.add_new_observationtype(co2_concentration)</span>
<span class="sd">            &gt;&gt;&gt; dataset.obstypes</span>
<span class="sd">            {&#39;temp&#39;: Obstype instance of temp, &#39;humidity&#39;: Obstype instance of humidity, &#39;radiation_temp&#39;: Obstype instance of radiation_temp, &#39;pressure&#39;: Obstype instance of pressure, &#39;pressure_at_sea_level&#39;: Obstype instance of pressure_at_sea_level, &#39;precip&#39;: Obstype instance of precip, &#39;precip_sum&#39;: Obstype instance of precip_sum, &#39;wind_speed&#39;: Obstype instance of wind_speed, &#39;wind_gust&#39;: Obstype instance of wind_gust, &#39;wind_direction&#39;: Obstype instance of wind_direction, &#39;co2&#39;: Obstype instance of co2}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test if the obstype is of the correct class.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Obstype</span><span class="p">,</span> <span class="n">Obstype_class</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Obstype</span><span class="si">}</span><span class="s2"> is not an instance of metobs_toolkit.obstypes.Obstype.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Test if the obsname is already in use</span>
        <span class="k">if</span> <span class="n">Obstype</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Obstype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already a known observation type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">Obstype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Update the known obstypes</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">Obstype</span><span class="si">}</span><span class="s2"> to the list of knonw observation types.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">Obstype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obstype</span></div>


<div class="viewcode-block" id="Dataset.add_new_unit">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.add_new_unit.html#metobs_toolkit.Dataset.add_new_unit">[docs]</a>
    <span class="k">def</span> <span class="nf">add_new_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obstype</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">,</span> <span class="n">conversion_expression</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new unit to a known observation type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obstype : str</span>
<span class="sd">            The observation type to add the new unit to.</span>
<span class="sd">        new_unit : str</span>
<span class="sd">            The new unit name.</span>
<span class="sd">        conversion_expression : list or str, optional</span>
<span class="sd">            The conversion expression to the standard unit of the observation</span>
<span class="sd">            type. The expression is a (list of) strings with simple algebraic</span>
<span class="sd">            operations, where x represent the value in the new unit, and the</span>
<span class="sd">            result is the value in the standard unit. Two examples for</span>
<span class="sd">            temperature (with a standard unit in Celsius):</span>

<span class="sd">                [&quot;x - 273.15&quot;] #if the new_unit is Kelvin</span>
<span class="sd">                [&quot;x-32.0&quot;, &quot;x/1.8&quot;] #if the new unit is Farenheit</span>

<span class="sd">            The default is [].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Create your Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset() #empty Dataset</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Add new unit to a known obstype</span>
<span class="sd">            &gt;&gt;&gt; dataset.add_new_unit(obstype = &#39;temp&#39;,</span>
<span class="sd">            ...                           new_unit= &#39;your_new_unit&#39;,</span>
<span class="sd">            ...                           conversion_expression = [&#39;x+3&#39;, &#39;x * 2&#39;])</span>
<span class="sd">            &gt;&gt;&gt; # The conversion means: 1 [your_new_unit] = (1 + 3) * 2 [C]</span>
<span class="sd">            &gt;&gt;&gt; dataset.obstypes[&#39;temp&#39;].get_info()</span>
<span class="sd">            temp observation with:</span>
<span class="sd">                 * standard unit: Celsius</span>
<span class="sd">                 * data column as None in None</span>
<span class="sd">                 * known units and aliases: {&#39;Celsius&#39;: [&#39;celsius&#39;, &#39;C&#39;, &#39;c&#39;, &#39;celcius&#39;, &#39;Celcius&#39;], &#39;Kelvin&#39;: [&#39;K&#39;, &#39;kelvin&#39;], &#39;Farenheit&#39;: [&#39;farenheit&#39;], &#39;your_new_unit&#39;: []}</span>
<span class="sd">                 * description: 2m - temperature</span>
<span class="sd">                 * conversions to known units: {&#39;Kelvin&#39;: [&#39;x - 273.15&#39;], &#39;Farenheit&#39;: [&#39;x-32.0&#39;, &#39;x/1.8&#39;], &#39;your_new_unit&#39;: [&#39;x+3&#39;, &#39;x * 2&#39;]}</span>
<span class="sd">                 * originates from data column: None with None as native unit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># test if observation is present</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obstype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obstype</span><span class="si">}</span><span class="s2"> is not a known obstype! No unit can be added.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># check if the unit is already present</span>
        <span class="n">is_present</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">test_if_unit_is_known</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_present</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_unit</span><span class="si">}</span><span class="s2"> is already a known unit of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obstype</span><span class="p">]</span><span class="o">.</span><span class="n">add_unit</span><span class="p">(</span>
            <span class="n">unit_name</span><span class="o">=</span><span class="n">new_unit</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="n">conversion_expression</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.show_settings">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.show_settings.html#metobs_toolkit.Dataset.show_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">show_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show detailed information of the stored Settings.</span>

<span class="sd">        A function that prints out all the settings, structured per thematic.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Create your Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset() #empty Dataset</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Show default settings</span>
<span class="sd">            &gt;&gt;&gt; dataset.show_settings()</span>
<span class="sd">            All settings:...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Dataset.get_station">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_station.html#metobs_toolkit.Dataset.get_station">[docs]</a>
    <span class="k">def</span> <span class="nf">get_station</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stationname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter out one station of the Dataset.</span>

<span class="sd">        Extract a metobs_toolkit.Station object from the dataset by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stationname : string</span>
<span class="sd">            The name of the station.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        metobs_toolkit.Station</span>
<span class="sd">            The station object.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Create your Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset() #empty Dataset</span>

<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; #Add observations to the Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; dataset.get_station(&#39;vlinder12&#39;)</span>
<span class="sd">            Station instance containing:</span>
<span class="sd">                 *1 stations</span>
<span class="sd">                 *[&#39;temp&#39;, &#39;humidity&#39;, &#39;wind_speed&#39;, &#39;wind_direction&#39;] observation types</span>
<span class="sd">                 *4320 observation records</span>
<span class="sd">                 *0 records labeled as outliers</span>
<span class="sd">                 *0 gaps</span>
<span class="sd">                 *0 missing observations</span>
<span class="sd">                 *records range: 2022-09-01 00:00:00+00:00 --&gt; 2022-09-15 23:55:00+00:00 (total duration:  14 days 23:55:00)</span>
<span class="sd">                 *time zone of the records: UTC</span>
<span class="sd">                 *Coordinates are available for all stations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">metobs_toolkit.station</span> <span class="kn">import</span> <span class="n">Station</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extract </span><span class="si">{</span><span class="n">stationname</span><span class="si">}</span><span class="s2"> from dataset.&quot;</span><span class="p">)</span>

        <span class="c1"># important: make sure all station attributes are of the same time as dataset.</span>
        <span class="c1"># so that all methods can be inherited.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sta_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">stationname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">drop_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sta_metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stationname</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">sta_metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stationname</span><span class="si">}</span><span class="s2"> not found in the dataset.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sta_outliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span>
                <span class="n">stationname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">drop_level</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sta_outliers</span> <span class="o">=</span> <span class="n">init_triple_multiindexdf</span><span class="p">()</span>

        <span class="n">sta_gaps</span> <span class="o">=</span> <span class="n">get_station_gaps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">,</span> <span class="n">stationname</span><span class="p">)</span>
        <span class="n">sta_missingobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="o">.</span><span class="n">get_station_missingobs</span><span class="p">(</span><span class="n">stationname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sta_gapfill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gapfilldf</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">stationname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">drop_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sta_gapfill</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sta_missingfill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span>
                <span class="n">stationname</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">drop_level</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">sta_missingfill</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Station</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">stationname</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="n">sta_df</span><span class="p">,</span>
            <span class="n">outliersdf</span><span class="o">=</span><span class="n">sta_outliers</span><span class="p">,</span>
            <span class="n">gaps</span><span class="o">=</span><span class="n">sta_gaps</span><span class="p">,</span>
            <span class="n">missing_obs</span><span class="o">=</span><span class="n">sta_missingobs</span><span class="p">,</span>
            <span class="n">gapfilldf</span><span class="o">=</span><span class="n">sta_gapfill</span><span class="p">,</span>
            <span class="n">missing_fill_df</span><span class="o">=</span><span class="n">sta_missingfill</span><span class="p">,</span>
            <span class="n">metadf</span><span class="o">=</span><span class="n">sta_metadf</span><span class="p">,</span>
            <span class="n">obstypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
            <span class="n">_qc_checked_obstypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_qc_checked_obstypes</span><span class="p">,</span>
            <span class="n">_applied_qc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># =============================================================================</span>
    <span class="c1">#   Gap Filling</span>
    <span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="Dataset.get_modeldata">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_modeldata.html#metobs_toolkit.Dataset.get_modeldata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_modeldata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">modelname</span><span class="o">=</span><span class="s2">&quot;ERA5_hourly&quot;</span><span class="p">,</span>
        <span class="n">modeldata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">obstype</span><span class="o">=</span><span class="s2">&quot;temp&quot;</span><span class="p">,</span>
        <span class="n">stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">startdt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enddt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make Modeldata for the Dataset.</span>

<span class="sd">        Make a metobs_toolkit.Modeldata object with modeldata at the locations</span>
<span class="sd">        of the stations present in the dataset. This Modeldata stores timeseries</span>
<span class="sd">        of model data for each station.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        modelname : str, optional</span>
<span class="sd">            Which dataset to download timeseries from. This is only used when</span>
<span class="sd">            no modeldata is provided. The default is &#39;ERA5_hourly&#39;.</span>
<span class="sd">        modeldata : metobs_toolkit.Modeldata, optional</span>
<span class="sd">            Use the modelname attribute and the gee information stored in the</span>
<span class="sd">            modeldata instance to extract timeseries.</span>
<span class="sd">        obstype : String, optional</span>
<span class="sd">            Name of the observationtype you want to apply gap filling on. The</span>
<span class="sd">            modeldata must contain this observation type as well. The</span>
<span class="sd">            default is &#39;temp&#39;.</span>
<span class="sd">        stations : string or list of strings, optional</span>
<span class="sd">            Stationnames to subset the modeldata to. If None, all stations will be used. The default is None.</span>
<span class="sd">        startdt : datetime.datetime, optional</span>
<span class="sd">            Start datetime of the model timeseries. If None, the start datetime of the dataset is used. The default is None.</span>
<span class="sd">        enddt : datetime.datetime, optional</span>
<span class="sd">            End datetime of the model timeseries. If None, the last datetime of the dataset is used. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Modl : metobs_toolkit.Modeldata</span>
<span class="sd">            The extracted modeldata for period and a set of stations.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If a timezone unaware datetime is given as an argument, it is interpreted</span>
<span class="sd">        as if it has the same timezone as the observations.</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>
<span class="sd">        When extracting large amounts of data, the timeseries data will be</span>
<span class="sd">        written to a file and saved on your google drive. In this case, you need</span>
<span class="sd">        to provide the Modeldata with the data using the .set_model_from_csv()</span>
<span class="sd">        method.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            import metobs_toolkit</span>

<span class="sd">            # Import data into a Dataset</span>
<span class="sd">            dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            dataset.update_settings(</span>
<span class="sd">                        input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">                        input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">                        template_file=metobs_toolkit.demo_template,</span>
<span class="sd">                        )</span>
<span class="sd">            dataset.import_data_from_file()</span>

<span class="sd">            # To limit data transfer, we define a short period</span>
<span class="sd">            import datetime</span>

<span class="sd">            tstart = datetime.datetime(2022, 9, 5)</span>
<span class="sd">            tend = datetime.datetime(2022, 9, 6)</span>


<span class="sd">            # Collect ERA5 2mT timeseries at your stations</span>
<span class="sd">            ERA5_data = dataset.get_modeldata(</span>
<span class="sd">                                    modelname=&quot;ERA5_hourly&quot;,</span>
<span class="sd">                                    modeldata=None,</span>
<span class="sd">                                    obstype=&quot;temp&quot;,</span>
<span class="sd">                                    stations=None,</span>
<span class="sd">                                    startdt=tstart,</span>
<span class="sd">                                    enddt=tend)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modeldata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Modl</span> <span class="o">=</span> <span class="n">Modeldata</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Modl</span> <span class="o">=</span> <span class="n">modeldata</span>
            <span class="n">modelname</span> <span class="o">=</span> <span class="n">Modl</span><span class="o">.</span><span class="n">modelname</span>

        <span class="c1"># Filters</span>

        <span class="k">if</span> <span class="n">startdt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">startdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">startdt</span> <span class="o">=</span> <span class="n">fmt_datetime_argument</span><span class="p">(</span>
                <span class="n">startdt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">enddt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">enddt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enddt</span> <span class="o">=</span> <span class="n">fmt_datetime_argument</span><span class="p">(</span>
                <span class="n">enddt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># make shure bounds include required range</span>
        <span class="n">Model_time_res</span> <span class="o">=</span> <span class="n">Modl</span><span class="o">.</span><span class="n">mapinfo</span><span class="p">[</span><span class="n">Modl</span><span class="o">.</span><span class="n">modelname</span><span class="p">][</span><span class="s2">&quot;time_res&quot;</span><span class="p">]</span>
        <span class="n">startdt</span> <span class="o">=</span> <span class="n">startdt</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Model_time_res</span><span class="p">)</span>
        <span class="n">enddt</span> <span class="o">=</span> <span class="n">enddt</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Model_time_res</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">stations</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">stations</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span>

        <span class="c1"># Convert to UTC</span>

        <span class="n">startdt_utc</span> <span class="o">=</span> <span class="n">startdt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">enddt_utc</span> <span class="o">=</span> <span class="n">enddt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

        <span class="c1"># fill modell with data</span>
        <span class="k">if</span> <span class="n">modelname</span> <span class="o">==</span> <span class="s2">&quot;ERA5_hourly&quot;</span><span class="p">:</span>
            <span class="n">Modl</span><span class="o">.</span><span class="n">get_ERA5_data</span><span class="p">(</span>
                <span class="n">metadf</span><span class="o">=</span><span class="n">metadf</span><span class="p">,</span>
                <span class="n">startdt_utc</span><span class="o">=</span><span class="n">startdt_utc</span><span class="p">,</span>
                <span class="n">enddt_utc</span><span class="o">=</span><span class="n">enddt_utc</span><span class="p">,</span>
                <span class="n">obstypes</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Modl</span><span class="o">.</span><span class="n">get_gee_dataset_data</span><span class="p">(</span>
                <span class="n">mapname</span><span class="o">=</span><span class="n">modelname</span><span class="p">,</span>
                <span class="n">metadf</span><span class="o">=</span><span class="n">metadf</span><span class="p">,</span>
                <span class="n">startdt_utc</span><span class="o">=</span><span class="n">startdt_utc</span><span class="p">,</span>
                <span class="n">enddt_utc</span><span class="o">=</span><span class="n">enddt_utc</span><span class="p">,</span>
                <span class="n">obstypes</span><span class="o">=</span><span class="n">obstype</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(When using the .set_model_from_csv() method, make sure the modelname of your Modeldata is </span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;(When using the .set_model_from_csv() method, make sure the modelname of your Modeldata is </span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Modl</span></div>


<div class="viewcode-block" id="Dataset.get_analysis">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_analysis.html#metobs_toolkit.Dataset.get_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">get_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_gapfilled_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an Analysis instance from the Dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        add_gapfilled_values : bool, optional</span>
<span class="sd">            If True, all filled values (from gapfill and missing observation fill),</span>
<span class="sd">            are added to the analysis records aswell. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        metobs_toolkit.Analysis</span>
<span class="sd">            The Analysis instance of the Dataset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt; dataset.coarsen_time_resolution(freq=&#39;1h&#39;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Create an Analysis from the dataset</span>
<span class="sd">            &gt;&gt;&gt; analysis = dataset.get_analysis()</span>
<span class="sd">            &gt;&gt;&gt; analysis</span>
<span class="sd">            Analysis instance containing:</span>
<span class="sd">                 *28 stations</span>
<span class="sd">                 *[&#39;temp&#39;, &#39;humidity&#39;, &#39;wind_speed&#39;, &#39;wind_direction&#39;] observation types</span>
<span class="sd">                 *10080 observation records</span>
<span class="sd">                 *Coordinates are available for all stations.</span>
<span class="sd">            &lt;BLANKLINE&gt;</span>
<span class="sd">                 *records range: 2022-09-01 00:00:00+00:00 --&gt; 2022-09-15 23:00:00+00:00 (total duration:  14 days 23:00:00)     *Coordinates are available for all stations.</span>
<span class="sd">            &lt;BLANKLINE&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># combine all to obsspace and include gapfill</span>
        <span class="k">if</span> <span class="n">add_gapfilled_values</span><span class="p">:</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_all_to_obsspace</span><span class="p">()</span>

            <span class="c1"># gapsfilled labels</span>
            <span class="n">gapfill_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_fill_info&quot;</span><span class="p">]</span>
            <span class="n">gapfilllabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">gapfill_settings</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

            <span class="c1"># missingfilled labels</span>
            <span class="n">missingfill_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">missing_obs</span><span class="p">[</span><span class="s2">&quot;missing_obs_fill_info&quot;</span><span class="p">]</span>
            <span class="n">missingfilllabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">missingfill_settings</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

            <span class="c1"># get all labels</span>
            <span class="n">fill_labels</span> <span class="o">=</span> <span class="n">gapfilllabels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">fill_labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">missingfilllabels</span><span class="p">)</span>
            <span class="n">fill_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fill_labels</span><span class="p">)]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;value&quot;</span><span class="p">]]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;obstype&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

        <span class="k">return</span> <span class="n">Analysis</span><span class="p">(</span>
            <span class="n">obsdf</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
            <span class="n">obstypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.write_to_csv">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.write_to_csv.html#metobs_toolkit.Dataset.write_to_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">write_to_csv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obstype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">include_fill_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add_final_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_tlk_obsnames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite_outliers_by_gaps_and_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">seperate_metadata_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write Dataset to a csv file.</span>

<span class="sd">        Write the dataset to a file where the observations, metadata and</span>
<span class="sd">        (if available) the quality labels per observation type are merged</span>
<span class="sd">        together.</span>

<span class="sd">        A final qualty control label for each</span>
<span class="sd">        quality-controlled-observation type can be added in the outputfile.</span>

<span class="sd">        The file will be written to the outputfolder specified in the settings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obstype : string, optional</span>
<span class="sd">            Specify an observation type to subset all observations to. If None,</span>
<span class="sd">            all available observation types are written to file. The default is</span>
<span class="sd">            None.</span>
<span class="sd">        filename : string, optional</span>
<span class="sd">            The name of the output csv file. If none, a standard-filename</span>
<span class="sd">            is generated based on the period of data. The default is None.</span>
<span class="sd">        include_outliers : bool, optional</span>
<span class="sd">            If True, the outliers will be present in the csv file. The default is True.</span>
<span class="sd">        include_fill_values : bool, optional</span>
<span class="sd">            If True, the filled gap and missing observation values will be</span>
<span class="sd">            present in the csv file. The default is True.</span>
<span class="sd">        add_final_labels : bool, optional</span>
<span class="sd">            If True, a column is added containing the final label of an observation. The default is True.</span>
<span class="sd">        use_tlk_obsnames : bool, optional</span>
<span class="sd">            If True, the standard naming of the metobs_toolkit is used, else</span>
<span class="sd">            the original names for obstypes is used. The default is True.</span>
<span class="sd">        overwrite_outliers_by_gaps_and_missing : bool, optional</span>
<span class="sd">            If the gaps and missing observations are updated using outliers,</span>
<span class="sd">            interpret these records as gaps/missing outliers if True. Else these</span>
<span class="sd">            will be interpreted as outliers. The default is True.</span>
<span class="sd">        seperate_metadata_file : bool, optional</span>
<span class="sd">            If true, the metadat is written to a seperate file, else the metadata</span>
<span class="sd">            is merged to the observation in one file. The default is True.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...            input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...            input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...            template_file=metobs_toolkit.demo_template)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Save dataset to a .csv file</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(output_folder = os.getcwd())</span>
<span class="sd">            &gt;&gt;&gt; dataset.write_to_csv(filename=&#39;your_saved_table.csv&#39;)</span>
<span class="sd">            write metadata to file: ...</span>
<span class="sd">            write dataset to file: ...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the dataset to a csv file&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Specify Settings.output_folder in order to export a csv.&quot;</span>

        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;The outputfolder: </span><span class="se">\</span>
<span class="s1">            </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> is not found. &#39;</span>

        <span class="c1"># combine all dataframes</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_all_to_obsspace</span><span class="p">(</span>
            <span class="n">overwrite_outliers_by_gaps_and_missing</span><span class="o">=</span><span class="n">overwrite_outliers_by_gaps_and_missing</span>
        <span class="p">)</span>  <span class="c1"># with outliers</span>
        <span class="c1"># Unstack mergedf</span>
        <span class="c1"># remove duplicates</span>
        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="o">~</span><span class="n">mergedf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span>

        <span class="c1"># drop outliers if required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_outliers</span><span class="p">:</span>
            <span class="n">outlier_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">var</span><span class="p">[</span><span class="s2">&quot;outlier_flag&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_checks_info&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="o">~</span><span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">outlier_labels</span><span class="p">)]</span>

        <span class="c1"># drop fill values if required</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_fill_values</span><span class="p">:</span>
            <span class="n">fill_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;gap fill&quot;</span><span class="p">,</span>
                <span class="s2">&quot;missing observation fill&quot;</span><span class="p">,</span>
            <span class="p">]</span>  <span class="c1"># toolkit representation labels</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="o">~</span><span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fill_labels</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">obstype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">xs_save</span><span class="p">(</span><span class="n">mergedf</span><span class="p">,</span> <span class="n">obstype</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="n">drop_level</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Map obstypes columns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_tlk_obsnames</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">get_orig_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;new_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mergedf</span><span class="p">[</span><span class="s2">&quot;obstype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obstype&quot;</span><span class="p">])</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;new_names&quot;</span><span class="p">:</span> <span class="s2">&quot;obstype&quot;</span><span class="p">})</span>
            <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">])</span>

        <span class="n">mergedf</span> <span class="o">=</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;obstype&quot;</span><span class="p">)</span>

        <span class="c1"># to one level for the columns</span>
        <span class="n">mergedf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; : &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mergedf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="c1"># columns to write</span>
        <span class="n">write_dataset_to_csv</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">mergedf</span><span class="p">,</span>
            <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">outputfolder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">],</span>
            <span class="n">seperate_metadata_file</span><span class="o">=</span><span class="n">seperate_metadata_file</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># =============================================================================</span>
    <span class="c1">#     Quality control</span>
    <span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="Dataset.combine_all_to_obsspace">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.combine_all_to_obsspace.html#metobs_toolkit.Dataset.combine_all_to_obsspace">[docs]</a>
    <span class="k">def</span> <span class="nf">combine_all_to_obsspace</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">repr_outl_as_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">overwrite_outliers_by_gaps_and_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make one dataframe with all observations and their labels.</span>

<span class="sd">        Combine all observations, outliers, missing observations and gaps into</span>
<span class="sd">        one Dataframe. All observation types are combined an a label is added</span>
<span class="sd">        in a serperate column.</span>

<span class="sd">        When gaps and missing records are updated from outliers one has to choice</span>
<span class="sd">        to represent these records as outliers or gaps. There can not be duplicates</span>
<span class="sd">        in the return dataframe.</span>

<span class="sd">        By default the observation values of the outliers are saved, one can</span>
<span class="sd">        choice to use these values or NaN&#39;s.</span>
<span class="sd">        following checks!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repr_outl_as_nan : bool, optional</span>
<span class="sd">            If True, Nan&#39;s are use for the values of the outliers. The</span>
<span class="sd">            default is False.</span>
<span class="sd">        overwrite_outliers_by_gaps_and_missing : Bool, optional</span>
<span class="sd">            If True, records that are labeld as gap/missing and outlier are</span>
<span class="sd">            labeled as gaps/missing. This has only effect when the gaps/missing</span>
<span class="sd">            observations are updated from the outliers. The default is True.</span>

<span class="sd">         Returns</span>
<span class="sd">         ---------</span>
<span class="sd">         combdf : pandas.DataFrame()</span>
<span class="sd">            A dataframe containing a continious time resolution of records, where each</span>
<span class="sd">            record is labeld.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt; dataset.coarsen_time_resolution(freq=&#39;1h&#39;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Apply quality control on the temperature observations</span>
<span class="sd">            &gt;&gt;&gt; dataset.apply_quality_control(obstype=&#39;temp&#39;) #Using the default QC settings</span>
<span class="sd">            &gt;&gt;&gt; dataset</span>
<span class="sd">            Dataset instance containing:</span>
<span class="sd">                 *28 stations</span>
<span class="sd">                 *[&#39;temp&#39;, &#39;humidity&#39;, &#39;wind_speed&#39;, &#39;wind_direction&#39;] observation types</span>
<span class="sd">                 *10080 observation records</span>
<span class="sd">                 *1676 records labeled as outliers</span>
<span class="sd">                 *0 gaps</span>
<span class="sd">                 *3 missing observations</span>
<span class="sd">                 *records range: 2022-09-01 00:00:00+00:00 --&gt; 2022-09-15 23:00:00+00:00 (total duration:  14 days 23:00:00)</span>
<span class="sd">                 *time zone of the records: UTC</span>
<span class="sd">                 *Coordinates are available for all stations.</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Combine all records to one dataframe in Observation-resolution</span>
<span class="sd">            &gt;&gt;&gt; overview_df = dataset.combine_all_to_obsspace()</span>
<span class="sd">            &gt;&gt;&gt; overview_df.head(12)</span>
<span class="sd">                                                                    value  ... toolkit_representation</span>
<span class="sd">            name      datetime                  obstype                    ...</span>
<span class="sd">            vlinder01 2022-09-01 00:00:00+00:00 humidity        65.000000  ...            observation</span>
<span class="sd">                                                temp            18.800000  ...            observation</span>
<span class="sd">                                                wind_direction  65.000000  ...            observation</span>
<span class="sd">                                                wind_speed       1.555556  ...            observation</span>
<span class="sd">                      2022-09-01 01:00:00+00:00 humidity        65.000000  ...            observation</span>
<span class="sd">                                                temp            18.400000  ...            observation</span>
<span class="sd">                                                wind_direction  55.000000  ...            observation</span>
<span class="sd">                                                wind_speed       1.416667  ...            observation</span>
<span class="sd">                      2022-09-01 02:00:00+00:00 humidity        68.000000  ...            observation</span>
<span class="sd">                                                temp            17.100000  ...            observation</span>
<span class="sd">                                                wind_direction  45.000000  ...            observation</span>
<span class="sd">                                                wind_speed       1.583333  ...            observation</span>
<span class="sd">            &lt;BLANKLINE&gt;</span>
<span class="sd">            [12 rows x 3 columns]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: label values from settings not hardcoding</span>

        <span class="c1"># TODO: use the repr_outl_as_nan argumenten here</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># Stack observations and outliers</span>
        <span class="c1"># =============================================================================</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="c1"># better save than sorry</span>
        <span class="n">present_obstypes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">present_obstypes</span><span class="p">]</span>

        <span class="c1"># to tripple index</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">future_stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;level_2&quot;</span><span class="p">:</span> <span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;observation&quot;</span>

        <span class="c1"># outliers</span>
        <span class="n">outliersdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outliersdf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;outlier&quot;</span>

        <span class="c1"># Careful! Some outliers exist on inport frequency (duplicated, invalid)</span>
        <span class="c1"># So only use the outliers for which station-datetime-obstype are present in the</span>
        <span class="c1"># dataset.df</span>
        <span class="n">outliersdf</span> <span class="o">=</span> <span class="n">outliersdf</span><span class="p">[</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

        <span class="c1"># remove outliers from the observations</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

        <span class="c1"># =============================================================================</span>
        <span class="c1"># Stack gaps</span>
        <span class="c1"># =============================================================================</span>
        <span class="c1"># add gapfill and remove the filled records from gaps</span>
        <span class="n">gapsfilldf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gapfilldf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># to triple index</span>
        <span class="n">gapsfilldf</span> <span class="o">=</span> <span class="n">value_labeled_doubleidxdf_to_triple_idxdf</span><span class="p">(</span>
            <span class="n">gapsfilldf</span><span class="p">,</span> <span class="n">known_obstypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">gapsfilldf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gap fill&quot;</span>

        <span class="n">gapsidx</span> <span class="o">=</span> <span class="n">get_gaps_indx_in_obs_space</span><span class="p">(</span>
            <span class="n">gapslist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">,</span>
            <span class="n">obsdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">outliersdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="p">,</span>
            <span class="n">resolutionseries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;dataset_resolution&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">gapsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">gapsidx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">present_obstypes</span><span class="p">)</span>
        <span class="n">gapsdf</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">gapsdf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">future_stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;level_2&quot;</span><span class="p">:</span> <span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">gapsdf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_info&quot;</span><span class="p">][</span><span class="s2">&quot;gap&quot;</span><span class="p">][</span><span class="s2">&quot;outlier_flag&quot;</span><span class="p">]</span>
        <span class="n">gapsdf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gap&quot;</span>

        <span class="c1"># Remove gaps from df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gapsdf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">overwrite_outliers_by_gaps_and_missing</span><span class="p">:</span>
            <span class="n">outliersdf</span> <span class="o">=</span> <span class="n">outliersdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">gapsdf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

        <span class="c1"># Remove gapfill values records from the gaps</span>
        <span class="n">gapsdf</span> <span class="o">=</span> <span class="n">gapsdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">gapsfilldf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># =============================================================================</span>
        <span class="c1"># Stack missing</span>
        <span class="c1"># =============================================================================</span>
        <span class="n">missingfilldf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_fill_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">missingfilldf</span> <span class="o">=</span> <span class="n">value_labeled_doubleidxdf_to_triple_idxdf</span><span class="p">(</span>
            <span class="n">missingfilldf</span><span class="p">,</span> <span class="n">known_obstypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">missingfilldf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;missing observation fill&quot;</span>

        <span class="c1"># add missing observations if they occure in observation space</span>
        <span class="n">missingidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="o">.</span><span class="n">get_missing_indx_in_obs_space</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;dataset_resolution&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">missingdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">missingidx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">present_obstypes</span><span class="p">)</span>

        <span class="n">missingdf</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">missingdf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">future_stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;level_2&quot;</span><span class="p">:</span> <span class="s2">&quot;obstype&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="n">missingdf</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_info&quot;</span><span class="p">][</span><span class="s2">&quot;missing_timestamp&quot;</span><span class="p">][</span>
            <span class="s2">&quot;outlier_flag&quot;</span>
        <span class="p">]</span>
        <span class="n">missingdf</span><span class="p">[</span><span class="s2">&quot;toolkit_representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;missing observation&quot;</span>

        <span class="c1"># Remove missing from df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">missingdf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">overwrite_outliers_by_gaps_and_missing</span><span class="p">:</span>
            <span class="n">outliersdf</span> <span class="o">=</span> <span class="n">outliersdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">missingdf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

        <span class="c1"># Remove missingfill values records from the missing</span>
        <span class="n">missingdf</span> <span class="o">=</span> <span class="n">missingdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">missingfilldf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># =============================================================================</span>
        <span class="c1"># combine all</span>
        <span class="c1"># =============================================================================</span>

        <span class="n">combdf</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df</span><span class="p">,</span> <span class="n">outliersdf</span><span class="p">,</span> <span class="n">gapsdf</span><span class="p">,</span> <span class="n">gapsfilldf</span><span class="p">,</span> <span class="n">missingdf</span><span class="p">,</span> <span class="n">missingfilldf</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">combdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;obstype&quot;</span><span class="p">]</span>
        <span class="c1"># To be shure?</span>
        <span class="n">combdf</span> <span class="o">=</span> <span class="n">combdf</span><span class="p">[</span><span class="o">~</span><span class="n">combdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">combdf</span></div>


    <span class="k">def</span> <span class="nf">update_outliersdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_to_outliersdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the outliersdf attribute.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="p">,</span> <span class="n">add_to_outliersdf</span><span class="p">])</span>

<div class="viewcode-block" id="Dataset.coarsen_time_resolution">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.coarsen_time_resolution.html#metobs_toolkit.Dataset.coarsen_time_resolution">[docs]</a>
    <span class="k">def</span> <span class="nf">coarsen_time_resolution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin_tz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the observations to coarser timeresolution.</span>

<span class="sd">        The assumed dataset resolution (stored in the metadf attribute) will be</span>
<span class="sd">        updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        origin : datetime.datetime, optional</span>
<span class="sd">            Define the origin (first timestamp) for the obervations. The origin</span>
<span class="sd">            is timezone naive, and is assumed to have the same timezone as the</span>
<span class="sd">            obervations. If None, the earliest occuring timestamp is used as</span>
<span class="sd">            origin. The default is None.</span>
<span class="sd">        origin_tz : str, optional</span>
<span class="sd">            Timezone string of the input observations. Element of</span>
<span class="sd">            pytz.all_timezones. If None, the timezone from the settings is</span>
<span class="sd">            used. The default is None.</span>
<span class="sd">        freq : DateOffset, Timedelta or str, optional</span>
<span class="sd">            The offset string or object representing target conversion.</span>
<span class="sd">            Ex: &#39;15min&#39; is 15 minutes, &#39;1h&#39;, is one hour. If None, the target time</span>
<span class="sd">            resolution of the dataset.settings is used. The default is None.</span>
<span class="sd">        method : &#39;nearest&#39; or &#39;bfill&#39;, optional</span>
<span class="sd">            Method to apply for the resampling. If None, the resample method of</span>
<span class="sd">            the dataset.settings is used. The default is None.</span>
<span class="sd">        limit : int, optional</span>
<span class="sd">            Limit of how many values to fill with one original observations. If</span>
<span class="sd">            None, the target limit of the dataset.settings is used. The default</span>
<span class="sd">            is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>
<span class="sd">            &gt;&gt;&gt; dataset.coarsen_time_resolution(freq=&#39;15min&#39;) #to 15 minutes resolution</span>
<span class="sd">            &gt;&gt;&gt; dataset.df[[&#39;temp&#39;, &#39;humidity&#39;]].head()</span>
<span class="sd">                                                 temp  humidity</span>
<span class="sd">            name      datetime</span>
<span class="sd">            vlinder01 2022-09-01 00:00:00+00:00  18.8      65</span>
<span class="sd">                      2022-09-01 00:15:00+00:00  18.7      65</span>
<span class="sd">                      2022-09-01 00:30:00+00:00  18.7      65</span>
<span class="sd">                      2022-09-01 00:45:00+00:00  18.6      65</span>
<span class="sd">                      2022-09-01 01:00:00+00:00  18.4      65</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;target_time_res&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;resample_method&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;resample_limit&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">origin_tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin_tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Coarsening the timeresolution to </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2"> using </span><span class="se">\</span>
<span class="s2">                    the </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">-method (with limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># test if coarsening the resolution is valid for the dataset</span>
        <span class="c1"># 1. If resolution-dep-qc is applied --&gt; coarsening is not valid and will result in a broken dataset</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span><span class="p">[</span>
                <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span><span class="p">[</span><span class="s2">&quot;checkname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;duplicated_timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid_input&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Coarsening time resolution is not possible because quality control checks that are resolution depening are already performed on the Dataset.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;(Apply coarsening_time_resolution BEFORE applying quality control.)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TODO: implement buffer method</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># find earlyest timestamp, if it is on the hour, use it else use the following hour</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">tstart</span><span class="o">.</span><span class="n">minute</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tstart</span><span class="o">.</span><span class="n">second</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tstart</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Round up to nearest hour</span>
                <span class="n">tstart</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin_tz_aware</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">origin_tz</span><span class="p">)</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">origin_tz_aware</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span>
                <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="c1"># Coarsen timeresolution</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;nearest&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">tstart</span><span class="p">)</span>
                <span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;bfill&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">tstart</span><span class="p">)</span>
                <span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The coarsening method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, is not implemented yet.&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

        <span class="c1"># Update resolution info in metadf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;dataset_resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="c1"># update df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># Remove gaps and missing from the observatios</span>
        <span class="c1"># most gaps and missing are already removed but when increasing timeres,</span>
        <span class="c1"># some records should be removed as well.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">remove_gaps_from_obs</span><span class="p">(</span><span class="n">gaplist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">,</span> <span class="n">obsdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="o">.</span><span class="n">remove_missing_from_obs</span><span class="p">(</span><span class="n">obsdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.sync_observations">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.sync_observations.html#metobs_toolkit.Dataset.sync_observations">[docs]</a>
    <span class="k">def</span> <span class="nf">sync_observations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tolerance</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">_force_resolution_minutes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_drop_target_nan_dt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplify and syncronize the observation timestamps.</span>

<span class="sd">        To simplify the resolution (per station), a tolerance is use to shift timestamps. The tolerance indicates the</span>
<span class="sd">        maximum translation in time that can be applied to an observation.</span>

<span class="sd">        The sycronisation tries to group stations that have an equal simplified resolution, and syncronize them. The origin</span>
<span class="sd">        of the sycronized timestamps will be set to round hours, round 10-minutes or round-5 minutes if possible given the tolerance.</span>

<span class="sd">        The observations present in the input file are used.</span>

<span class="sd">        After syncronization, the IO outliers, missing observations and gaps are recomputed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tolerance :  Timedelta or str</span>
<span class="sd">            The tolerance string or object representing the maximum translation in time.</span>
<span class="sd">            Ex: &#39;5min&#39; is 5 minutes, &#39;1h&#39;, is one hour.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, a dataframe illustrating the mapping from original datetimes to simplified and syncronized is returned. The default is True.</span>
<span class="sd">        _drop_target_nan_dt : bool, optional</span>
<span class="sd">            If record has no target datetime, the datetimes will be listed as Nat. To remove them,</span>
<span class="sd">            set this to True. Default is False.</span>
<span class="sd">        _force_resolution_minutes : bool, optional</span>
<span class="sd">            force the resolution estimate to this frequency in minutes. If None, the frequency is estimated. The default is None.</span>
<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        Keep in mind that this method will overwrite the df, outliersdf, missing timestamps and gaps.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        Because the used observations are from the input file, previously coarsend timeresolutions are ignored.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame (if verbose is True)</span>
<span class="sd">            A dataframe containing the original observations with original timestamps and the corresponding target timestamps.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get columns pressent in metadf, because the input df can have columns</span>
        <span class="c1"># that does not have to be mapped to the toolkit</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_df</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">),</span> <span class="s2">&quot;To syncronize a dataset, the (pure) input dataframe cannot be empty.&quot;</span>

        <span class="n">init_meta_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_df</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="n">init_triple_multiindexdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gapfilldf</span> <span class="o">=</span> <span class="n">init_multiindexdf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># find simplified resolution</span>
        <span class="k">if</span> <span class="n">_force_resolution_minutes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">simplified_resolution</span> <span class="o">=</span> <span class="n">get_freqency_series</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
                <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">max_simplify_error</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_force_resolution_minutes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># TODO</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;foce resolution minutes as a list is not implemented yet, sorry.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span>
                <span class="n">freq_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">_force_resolution_minutes</span><span class="p">))]</span>
                    <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">simplified_resolution</span> <span class="o">=</span> <span class="n">freq_series</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syncronizing to these resolutions: </span><span class="si">{</span><span class="n">simplified_resolution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">occuring_resolutions</span> <span class="o">=</span> <span class="n">simplified_resolution</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">find_simple_origin</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tstart</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tstart</span><span class="o">.</span><span class="n">second</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tstart</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tstart</span>  <span class="c1"># already a round hour</span>

            <span class="c1"># try converting to a round hour</span>
            <span class="n">tstart_round_hour</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s2">&quot;60min&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tstart</span> <span class="o">-</span> <span class="n">tstart_round_hour</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">tolerance</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tstart_round_hour</span>

            <span class="c1"># try converting to a tenfold in minutes</span>
            <span class="n">tstart_round_tenfold</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s2">&quot;10min&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tstart</span> <span class="o">-</span> <span class="n">tstart_round_tenfold</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">tolerance</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tstart_round_tenfold</span>

            <span class="c1"># try converting to a fivefold in minutes</span>
            <span class="n">tstart_round_fivefold</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s2">&quot;5min&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tstart</span> <span class="o">-</span> <span class="n">tstart_round_fivefold</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">tolerance</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tstart_round_fivefold</span>

            <span class="c1"># no suitable conversion found</span>
            <span class="k">return</span> <span class="n">tstart</span>

        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">_total_verbose_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">occur_res</span> <span class="ow">in</span> <span class="n">occuring_resolutions</span><span class="p">:</span>
            <span class="n">group_stations</span> <span class="o">=</span> <span class="n">simplified_resolution</span><span class="p">[</span>
                <span class="n">simplified_resolution</span> <span class="o">==</span> <span class="n">occur_res</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; Grouping stations with simplified resolution of </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">occur_res</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">group_stations</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">groupdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_stations</span><span class="p">)]</span>

            <span class="n">tstart</span> <span class="o">=</span> <span class="n">groupdf</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">tend</span> <span class="o">=</span> <span class="n">groupdf</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># find a good origin point</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">find_simple_origin</span><span class="p">(</span><span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>

            <span class="c1"># Create records index</span>
            <span class="n">target_records</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tend</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">occur_res</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>

            <span class="n">target_records</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;target_datetime&quot;</span>
            <span class="c1"># convert records to new target records, station per station</span>

            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">group_stations</span><span class="p">:</span>
                <span class="n">stadf</span> <span class="o">=</span> <span class="n">groupdf</span><span class="p">[</span><span class="n">groupdf</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sta</span><span class="p">]</span>
                <span class="c1"># Drop all nan values! these will be added later from the outliersdf</span>
                <span class="n">stadf</span> <span class="o">=</span> <span class="n">stadf</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

                <span class="c1"># drop all records per statiotion for which there are no obsecvations</span>
                <span class="n">present_obs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

                <span class="n">stadf</span> <span class="o">=</span> <span class="n">stadf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">stadf</span><span class="p">[</span><span class="n">present_obs</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

                <span class="n">stadf</span> <span class="o">=</span> <span class="n">stadf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

                <span class="n">mergedstadf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span>
                    <span class="n">left</span><span class="o">=</span><span class="n">stadf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">),</span>
                    <span class="n">right</span><span class="o">=</span><span class="n">target_records</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span>
                    <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;target_datetime&quot;</span><span class="p">,</span>
                    <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                    <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                    <span class="n">tolerance</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">tolerance</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">_drop_target_nan_dt</span><span class="p">:</span>
                    <span class="n">mergedstadf</span> <span class="o">=</span> <span class="n">mergedstadf</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;target_datetime&quot;</span><span class="p">)</span>
                <span class="c1"># possibility 1: record is mapped crrectly</span>
                <span class="n">correct_mapped</span> <span class="o">=</span> <span class="n">mergedstadf</span><span class="p">[</span><span class="o">~</span><span class="n">mergedstadf</span><span class="p">[</span><span class="s2">&quot;target_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

                <span class="c1"># possibility2: records that ar not mapped to target</span>
                <span class="c1"># not_mapped_records =mergedstadf[mergedstadf[&#39;target_datetime&#39;].isnull()]</span>

                <span class="c1"># possibilyt 3 : no suitable candidates found for the target</span>
                <span class="c1"># these will be cached by the missing and gap check</span>
                <span class="c1"># no_record_candidates = target_records[~target_records.isin(mergedstadf[&#39;target_datetime&#39;])].values</span>

                <span class="n">merged_df</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">correct_mapped</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">_total_verbose_df</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">([</span><span class="n">_total_verbose_df</span><span class="p">,</span> <span class="n">mergedstadf</span><span class="p">])</span>

        <span class="c1"># overwrite the df with the synced observations</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">merged_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;original_datetime&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;target_datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;original_datetime&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># self.df = merged_df</span>

        <span class="c1"># Recompute the dataset attributes, apply qc, gap and missing searches, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construct_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">merged_df</span><span class="p">,</span>
            <span class="n">freq_estimation_method</span><span class="o">=</span><span class="s2">&quot;highest&quot;</span><span class="p">,</span>
            <span class="n">freq_estimation_simplify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">freq_estimation_simplify_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fixed_freq_series</span><span class="o">=</span><span class="n">simplified_resolution</span><span class="p">,</span>
            <span class="n">update_full_metadf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># Do not overwrite full metadf, only the frequencies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span>
            <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">init_meta_cols</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">_total_verbose_df</span> <span class="o">=</span> <span class="n">_total_verbose_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;original_datetime&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;target_datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">_total_verbose_df</span></div>


<div class="viewcode-block" id="Dataset.import_data_from_file">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.import_data_from_file.html#metobs_toolkit.Dataset.import_data_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">import_data_from_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_data_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">input_metadata_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">template_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_estimation_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_estimation_simplify</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_estimation_simplify_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kwargs_data_read</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">kwargs_metadata_read</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read observations from a csv file.</span>

<span class="sd">        The paths (data, metadata and template) are stored in the settings if</span>
<span class="sd">        Dataset.update_settings() is called on this object. These paths can be</span>
<span class="sd">        updated by adding them as argument to this method.</span>

<span class="sd">        The input data (and metadata) are interpreted by using a template</span>
<span class="sd">        (json file).</span>

<span class="sd">        An estimation of the observational frequency is made per station. This is used</span>
<span class="sd">        to find missing observations and gaps.</span>

<span class="sd">        The Dataset attributes are set and the following checks are executed:</span>
<span class="sd">                * Duplicate check</span>
<span class="sd">                * Invalid input check</span>
<span class="sd">                * Find missing observations</span>
<span class="sd">                * Find gaps</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_data_file : string, optional</span>
<span class="sd">            Path to the input data file with observations. If None, the input</span>
<span class="sd">            data path in the settings is used.</span>
<span class="sd">        input_metadata_file : string, optional</span>
<span class="sd">            Path to the input metadata file. If None, the input metadata path</span>
<span class="sd">            in the settings is used.</span>
<span class="sd">        template_file : string, optional</span>
<span class="sd">            Path to the template (json) file to be used on the observations</span>
<span class="sd">            and metadata. If None, the template path in the settings is used.</span>
<span class="sd">        freq_estimation_method : &#39;highest&#39; or &#39;median&#39;, optional</span>
<span class="sd">            Select wich method to use for the frequency estimation. If</span>
<span class="sd">            &#39;highest&#39;, the highest apearing frequency is used. If &#39;median&#39;, the</span>
<span class="sd">            median of the apearing frequencies is used. If None, the method</span>
<span class="sd">            stored in the</span>
<span class="sd">            Dataset.settings.time_settings[&#39;freq_estimation_method&#39;] is used.</span>
<span class="sd">            The default is None.</span>
<span class="sd">        freq_estimation_simplify : bool, optional</span>
<span class="sd">            If True, the likely frequency is converted to round hours, or round minutes.</span>
<span class="sd">            The &quot;freq_estimation_simplify_error&#39; is used as a constrain. If the constrain is not met,</span>
<span class="sd">            the simplification is not performed. If None, the method</span>
<span class="sd">            stored in the</span>
<span class="sd">            Dataset.settings.time_settings[&#39;freq_estimation_simplify&#39;] is used.</span>
<span class="sd">            The default is None.</span>
<span class="sd">        freq_estimation_simplify_error : Timedelta or str, optional</span>
<span class="sd">            The tolerance string or object representing the maximum translation in time to form a simplified frequency estimation.</span>
<span class="sd">            Ex: &#39;5min&#39; is 5 minutes, &#39;1h&#39;, is one hour. If None, the method</span>
<span class="sd">            stored in the</span>
<span class="sd">            Dataset.settings.time_settings[&#39;freq_estimation_simplify_error&#39;] is</span>
<span class="sd">            used. The default is None.</span>
<span class="sd">        kwargs_data_read : dict, optional</span>
<span class="sd">            Keyword arguments collected in a dictionary to pass to the</span>
<span class="sd">            pandas.read_csv() function on the data file. The default is {}.</span>
<span class="sd">        kwargs_metadata_read : dict, optional</span>
<span class="sd">            Keyword arguments collected in a dictionary to pass to the</span>
<span class="sd">            pandas.read_csv() function on the metadata file. The default is {}.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        In pracktice, the default arguments will be sufficient for most applications.</span>

<span class="sd">        Note</span>
<span class="sd">        --------</span>
<span class="sd">        If options are present in the template, these will have priority over the arguments of this function.</span>

<span class="sd">        Warning</span>
<span class="sd">        ---------</span>
<span class="sd">        All CSV data files must be in *UTF-8 encoding*. For most CSV files,</span>
<span class="sd">        this condition is already met. To make sure, in Microsoft Excel (or</span>
<span class="sd">        similar), you can specify to export as **`CSV UTF-8`**. If you</span>
<span class="sd">        encounter an error, mentioning a `&quot;/ueff...&quot;` tag in a CSV file, it is</span>
<span class="sd">        often solved by converting the CSV to UTF-8.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            &gt;&gt;&gt; import metobs_toolkit</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # Import data into a Dataset</span>
<span class="sd">            &gt;&gt;&gt; dataset = metobs_toolkit.Dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.update_settings(</span>
<span class="sd">            ...                         input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">            ...                         input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">            ...                         template_file=metobs_toolkit.demo_template,</span>
<span class="sd">            ...                         )</span>
<span class="sd">            &gt;&gt;&gt; dataset.import_data_from_file()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Importing data from file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_data_file&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Update paths to the input files, if given.</span>
        <span class="k">if</span> <span class="n">input_data_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_settings</span><span class="p">(</span><span class="n">input_data_file</span><span class="o">=</span><span class="n">input_data_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_metadata_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_settings</span><span class="p">(</span><span class="n">input_metadata_file</span><span class="o">=</span><span class="n">input_metadata_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">template_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_settings</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="n">template_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freq_estimation_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_estimation_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span>
                <span class="s2">&quot;freq_estimation_method&quot;</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">freq_estimation_simplify</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_estimation_simplify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span>
                <span class="s2">&quot;freq_estimation_simplify&quot;</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">freq_estimation_simplify_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_estimation_simplify_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span>
                <span class="s2">&quot;freq_estimation_simplify_error&quot;</span>
            <span class="p">]</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">templatefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No templatefile is specified.&quot;</span>

        <span class="c1"># Read template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">read_template_from_file</span><span class="p">(</span><span class="n">jsonpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">templatefile</span><span class="p">)</span>

        <span class="c1"># overload the timezone from template to the settings</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_tz</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">get_tz</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Set timezone = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">get_tz</span><span class="p">()</span><span class="si">}</span><span class="s2"> from options in template.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Read observations into pandas dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">import_data_from_csv</span><span class="p">(</span>
            <span class="n">input_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_data_file&quot;</span><span class="p">],</span>
            <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
            <span class="n">known_obstypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">kwargs_data_read</span><span class="o">=</span><span class="n">kwargs_data_read</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Set timezone information</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span>
            <span class="n">tz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">time_settings</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">],</span>
            <span class="n">ambiguous</span><span class="o">=</span><span class="s2">&quot;infer&quot;</span><span class="p">,</span>
            <span class="n">nonexistent</span><span class="o">=</span><span class="s2">&quot;shift_forward&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># drop Nat datetimes if present</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_data_file&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">                     imported to dataframe </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_metadata_file&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No metadata file is defined,</span><span class="se">\</span>
<span class="s2">                    no metadata attributes can be set!&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Importing metadata from file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_metadata_file&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">meta_df</span> <span class="o">=</span> <span class="n">import_metadata_from_csv</span><span class="p">(</span>
                <span class="n">input_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">IO</span><span class="p">[</span><span class="s2">&quot;input_metadata_file&quot;</span><span class="p">],</span>
                <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
                <span class="n">kwargs_metadata_read</span><span class="o">=</span><span class="n">kwargs_metadata_read</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># in dataset of one station</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_is_data_single_station</span><span class="p">():</span>
                <span class="c1"># logger.warning(&quot;No station names find in the observations!&quot;)</span>

                <span class="c1"># If there is ONE name in the metadf, than we use that name for</span>
                <span class="c1"># the df, else we use the default name</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">meta_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">meta_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">meta_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;One stationname found in the metadata: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, this name is used for the data.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;default_name&quot;</span><span class="p">])</span>
                    <span class="c1"># for later merging, we add the name column with the default</span>
                    <span class="c1"># also in the metadf</span>
                    <span class="n">meta_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;default_name&quot;</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Assume the dataset is for ONE station with the </span><span class="se">\</span>
<span class="s1">                        default name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">app</span><span class="p">[</span><span class="s2">&quot;default_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.&#39;</span>
                    <span class="p">)</span>

            <span class="c1"># merge additional metadata to observations</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head of data file, before merge: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head of metadata file, before merge: </span><span class="si">{</span><span class="n">meta_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">meta_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">meta_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">colname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">additional_meta_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">meta_cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">additional_meta_cols</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Merging metadata (</span><span class="si">{</span><span class="n">additional_meta_cols</span><span class="si">}</span><span class="s2">) to dataset data by name.&quot;</span>
                <span class="p">)</span>
                <span class="n">additional_meta_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>  <span class="c1"># merging on name</span>
                <span class="c1"># merge deletes datetime index somehow? so add it back.</span>
                <span class="n">df_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">right</span><span class="o">=</span><span class="n">meta_df</span><span class="p">[</span><span class="n">additional_meta_cols</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;name&quot;</span>
                <span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_index</span>

        <span class="c1"># update dataset object</span>

        <span class="c1"># Remove stations whith only one observation (no freq estimation)</span>
        <span class="n">station_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">issue_station</span> <span class="o">=</span> <span class="n">station_counts</span><span class="p">[</span><span class="n">station_counts</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;These stations will be removed because of only having one record: </span><span class="si">{</span><span class="n">issue_station</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">issue_station</span><span class="p">)]</span>

        <span class="c1"># convert dataframe to multiindex (datetime - name)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>

        <span class="c1"># Sort by name and then by datetime (to avoid negative freq)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

        <span class="c1"># dataframe with all data of input file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
        <span class="c1"># Construct all attributes of the Dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construct_dataset</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
            <span class="n">freq_estimation_method</span><span class="o">=</span><span class="n">freq_estimation_method</span><span class="p">,</span>
            <span class="n">freq_estimation_simplify</span><span class="o">=</span><span class="n">freq_estimation_simplify</span><span class="p">,</span>
            <span class="n">freq_estimation_simplify_error</span><span class="o">=</span><span class="n">freq_estimation_simplify_error</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_construct_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">freq_estimation_method</span><span class="p">,</span>
        <span class="n">freq_estimation_simplify</span><span class="p">,</span>
        <span class="n">freq_estimation_simplify_error</span><span class="p">,</span>
        <span class="n">fixed_freq_series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">update_full_metadf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the Dataset class from a IO dataframe.</span>

<span class="sd">        The df, metadf, outliersdf, gaps, missing timestamps and observationtypes attributes are set.</span>


<span class="sd">        The observations are converted to the toolkit standard units if possible.</span>

<span class="sd">        Qc on IO is applied (duplicated check and invalid check) + gaps and missing</span>
<span class="sd">        values are defined by assuming a frequency per station.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.dataframe</span>
<span class="sd">            The dataframe containing the input observations and metadata.</span>
<span class="sd">        freq_estimation_method : &#39;highest&#39; or &#39;median&#39;</span>
<span class="sd">            Select wich method to use for the frequency estimation. If</span>
<span class="sd">            &#39;highest&#39;, the highest apearing frequency is used. If &#39;median&#39;, the</span>
<span class="sd">            median of the apearing frequencies is used.</span>
<span class="sd">        freq_estimation_simplify : bool</span>
<span class="sd">            If True, the likely frequency is converted to round hours, or round minutes.</span>
<span class="sd">            The &quot;freq_estimation_simplify_error&#39; is used as a constrain. If the constrain is not met,</span>
<span class="sd">            the simplification is not performed.</span>
<span class="sd">        freq_estimation_simplify_error : Timedelta or str, optional</span>
<span class="sd">            The tolerance string or object representing the maximum translation in time to form a simplified frequency estimation.</span>
<span class="sd">            Ex: &#39;5min&#39; is 5 minutes, &#39;1h&#39;, is one hour.</span>
<span class="sd">        fixed_freq_series : pandas.series or None, optional</span>
<span class="sd">            If you do not want the frequencies to be recalculated, one can pass the</span>
<span class="sd">            frequency series to update the metadf[&quot;dataset_resolution&quot;]. If None, the frequencies will be estimated. The default is None.</span>
<span class="sd">        update_full_metadf : bool, optional</span>
<span class="sd">            If True, the full Dataset.metadf will be updated. If False, only the frequency columns in the Dataset.metadf will be updated. The default is True.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert dataframe to dataset attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_df_attribute</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">update_metadf</span><span class="o">=</span><span class="n">update_full_metadf</span><span class="p">)</span>

        <span class="c1"># Check observation types and convert units if needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_of_obstypes_and_units</span><span class="p">()</span>

        <span class="c1"># Apply quality control on Import resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_qc_on_import</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fixed_freq_series</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_series</span> <span class="o">=</span> <span class="n">get_freqency_series</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">freq_estimation_method</span><span class="p">,</span>
                <span class="n">simplify</span><span class="o">=</span><span class="n">freq_estimation_simplify</span><span class="p">,</span>
                <span class="n">max_simplify_error</span><span class="o">=</span><span class="n">freq_estimation_simplify_error</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">freq_series_import</span> <span class="o">=</span> <span class="n">freq_series</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;assumed_import_frequency&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">freq_series_import</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span>
                    <span class="s2">&quot;assumed_import_frequency&quot;</span>
                <span class="p">]</span>  <span class="c1"># No update</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freq_series_import</span> <span class="o">=</span> <span class="n">fixed_freq_series</span>
            <span class="n">freq_series</span> <span class="o">=</span> <span class="n">fixed_freq_series</span>

        <span class="c1"># add import frequencies to metadf (after import qc!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;assumed_import_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq_series_import</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;dataset_resolution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq_series</span>

        <span class="c1"># Remove gaps and missing from the observations AFTER timecoarsening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">remove_gaps_from_obs</span><span class="p">(</span><span class="n">gaplist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaps</span><span class="p">,</span> <span class="n">obsdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="o">.</span><span class="n">remove_missing_from_obs</span><span class="p">(</span><span class="n">obsdf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initiate_df_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">update_metadf</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize dataframe attributes.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating dataset by dataframe with shape: </span><span class="si">{</span><span class="n">dataframe</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Create dataframe with fixed order of observational columns</span>
        <span class="n">obs_col_order</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">obs_col_order</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">update_metadf</span><span class="p">:</span>
            <span class="n">metadf</span> <span class="o">=</span> <span class="n">dataframe</span>

            <span class="c1"># create metadataframe</span>
            <span class="n">metacolumns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_metadata_column_map</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">metacolumns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>  <span class="c1"># This is the index</span>
            <span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">metacolumns</span><span class="p">)</span>
            <span class="n">metadf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>  <span class="c1"># drop datetimeindex</span>

            <span class="c1"># drop dubplicates due to datetime</span>
            <span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf</span><span class="p">[</span><span class="o">~</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)]</span>

            <span class="c1"># &quot;lat&#39; and &#39;lon&#39; column are required, so add them as empty if not present</span>
            <span class="k">if</span> <span class="s2">&quot;lat&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="s2">&quot;lon&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">metadf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="n">metadf_to_gdf</span><span class="p">(</span><span class="n">metadf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_qc_on_import</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if the name is Nan, remove these records from df, and metadf (before)</span>
        <span class="c1"># they end up in the gaps and missing obs</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Following observations are not linked to a station name and will be removed: </span><span class="si">{</span><span class="n">xs_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Following station will be removed from the Dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

        <span class="c1"># find missing obs and gaps, and remove them from the df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaps</span> <span class="o">=</span> <span class="n">missing_timestamp_and_gap_check</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">gapsize_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gap</span><span class="p">[</span><span class="s2">&quot;gaps_settings&quot;</span><span class="p">][</span><span class="s2">&quot;gaps_finder&quot;</span><span class="p">][</span><span class="s2">&quot;gapsize_n&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create gaps and missing obs objects</span>
        <span class="c1"># self.gaps = gaps_list</span>
        <span class="c1"># self.missing_obs = Missingob_collection(missing_obs)</span>

        <span class="c1"># Perform QC checks on original observation frequencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">dup_outl_df</span> <span class="o">=</span> <span class="n">duplicate_timestamp_check</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span>
            <span class="n">checks_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_checks_info&quot;</span><span class="p">],</span>
            <span class="n">checks_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_check_settings&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dup_outl_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_outliersdf</span><span class="p">(</span><span class="n">add_to_outliersdf</span><span class="o">=</span><span class="n">dup_outl_df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">nan_outl_df</span> <span class="o">=</span> <span class="n">invalid_input_check</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">checks_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s2">&quot;qc_checks_info&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nan_outl_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_outliersdf</span><span class="p">(</span><span class="n">nan_outl_df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outliersdf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1"># update the order and which qc is applied on which obstype</span>
        <span class="n">checked_obstypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obs</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">obs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">checknames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;duplicated_timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid_input&quot;</span><span class="p">]</span>  <span class="c1"># KEEP order</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_applied_qc</span><span class="p">,</span>
                <span class="n">conv_applied_qc_to_df</span><span class="p">(</span>
                    <span class="n">obstypes</span><span class="o">=</span><span class="n">checked_obstypes</span><span class="p">,</span> <span class="n">ordered_checknames</span><span class="o">=</span><span class="n">checknames</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_of_obstypes_and_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to setup all attributes related to observation types and</span>
<span class="sd">        convert to standard units.&quot;&quot;&quot;</span>

        <span class="c1"># Check if all present observation types are known.</span>
        <span class="n">unknown_obs_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obs_col</span>
            <span class="k">for</span> <span class="n">obs_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">obs_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_obs_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following observation types are unknown: </span><span class="si">{</span><span class="n">unknown_obs_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">obs_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Convert the units to the toolkit standards (if unit is known)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">obs_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obs_col</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_standard_units</span><span class="p">(</span>
                <span class="n">input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">obs_col</span><span class="p">],</span>
                <span class="n">input_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_input_unit_of_tlk_obstype</span><span class="p">(</span><span class="n">obs_col</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Update the description of the obstype</span>
            <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_description_of_tlk_obstype</span><span class="p">(</span><span class="n">obs_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
                <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obs_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

            <span class="c1"># Update the original column name and original units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obs_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_original_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_original_obstype_columnname</span><span class="p">(</span><span class="n">obs_col</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="p">[</span><span class="n">obs_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_original_unit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">_get_input_unit_of_tlk_obstype</span><span class="p">(</span><span class="n">obs_col</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># subset the obstypes attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obstypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">}</span>

    <span class="c1"># =============================================================================</span>
    <span class="c1"># Physiography extractions</span>
    <span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="Dataset.get_lcz">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_lcz.html#metobs_toolkit.Dataset.get_lcz">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lcz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract local climate zones for all stations.</span>

<span class="sd">        Function to extract the Local CLimate zones (LCZ) from the</span>
<span class="sd">        wudapt global LCZ map on the Google engine for all stations.</span>

<span class="sd">        A &#39;LCZ&#39; column will be added to the metadf, and series is returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lcz_series : pandas.Series()</span>
<span class="sd">            A series with the stationnames as index and the LCZ as values.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">             import metobs_toolkit</span>

<span class="sd">             # Import data into a Dataset</span>
<span class="sd">             dataset = metobs_toolkit.Dataset()</span>
<span class="sd">             dataset.update_settings(</span>
<span class="sd">                                     input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">                                     input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">                                     template_file=metobs_toolkit.demo_template,</span>
<span class="sd">                                     )</span>
<span class="sd">             dataset.import_data_from_file()</span>

<span class="sd">             # Get the local climate zones for all stations</span>
<span class="sd">             lcz_series = dataset.get_lcz()</span>

<span class="sd">             # in addition to the returned series, the metadf attribute is updated aswell</span>
<span class="sd">             print(dataset.metadf)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connect to gee</span>
        <span class="n">connect_to_gee</span><span class="p">()</span>

        <span class="c1"># Extract LCZ for all stations</span>
        <span class="n">lcz_series</span> <span class="o">=</span> <span class="n">lcz_extractor</span><span class="p">(</span>
            <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span>
            <span class="n">mapinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gee</span><span class="p">[</span><span class="s2">&quot;gee_dataset_info&quot;</span><span class="p">][</span><span class="s2">&quot;global_lcz_map&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># drop column if it was already present</span>
        <span class="k">if</span> <span class="s2">&quot;lcz&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lcz&quot;</span><span class="p">])</span>

        <span class="c1"># update metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">lcz_series</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lcz_series</span></div>


<div class="viewcode-block" id="Dataset.get_altitude">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_altitude.html#metobs_toolkit.Dataset.get_altitude">[docs]</a>
    <span class="k">def</span> <span class="nf">get_altitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract Altitudes for all stations.</span>

<span class="sd">        Function to extract the Altitude from the SRTM Digital Elevation Data</span>
<span class="sd">        global map on the Google engine for all stations.</span>

<span class="sd">        A &#39;altitude&#39; column will be added to the metadf, and series is returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        altitude_series : pandas.Series()</span>
<span class="sd">            A series with the stationnames as index and the altitudes as values.</span>

<span class="sd">         Examples</span>
<span class="sd">         --------</span>
<span class="sd">         .. code-block:: python</span>

<span class="sd">              import metobs_toolkit</span>

<span class="sd">              # Import data into a Dataset</span>
<span class="sd">              dataset = metobs_toolkit.Dataset()</span>
<span class="sd">              dataset.update_settings(</span>
<span class="sd">                                      input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">                                      input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">                                      template_file=metobs_toolkit.demo_template,</span>
<span class="sd">                                      )</span>
<span class="sd">              dataset.import_data_from_file()</span>

<span class="sd">              # Get the altitude for all stations</span>
<span class="sd">              alt_series = dataset.get_altitude()</span>

<span class="sd">              # in addition to the returned series, the metadf attribute is updated aswell</span>
<span class="sd">              print(dataset.metadf)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connect to gee</span>
        <span class="n">connect_to_gee</span><span class="p">()</span>

        <span class="c1"># Extract LCZ for all stations</span>
        <span class="n">altitude_series</span> <span class="o">=</span> <span class="n">height_extractor</span><span class="p">(</span>
            <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span>
            <span class="n">mapinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gee</span><span class="p">[</span><span class="s2">&quot;gee_dataset_info&quot;</span><span class="p">][</span><span class="s2">&quot;DEM&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># drop column if it was already present</span>
        <span class="k">if</span> <span class="s2">&quot;altitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">])</span>

        <span class="c1"># update metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">altitude_series</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">altitude_series</span></div>


<div class="viewcode-block" id="Dataset.get_landcover">
<a class="viewcode-back" href="../../reference/api/metobs_toolkit.Dataset.get_landcover.html#metobs_toolkit.Dataset.get_landcover">[docs]</a>
    <span class="k">def</span> <span class="nf">get_landcover</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">buffers</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
        <span class="n">aggregate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">gee_map</span><span class="o">=</span><span class="s2">&quot;worldcover&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract landcover for all stations.</span>

<span class="sd">        Extract the landcover fractions in a buffer with a specific radius for</span>
<span class="sd">        all stations. If an aggregation scheme is define, one can choose to</span>
<span class="sd">        aggregate the landcoverclasses.</span>

<span class="sd">        The landcover fractions will be added to the Dataset.metadf if overwrite</span>
<span class="sd">        is True. Presented as seperate columns where each column represent the</span>
<span class="sd">        landcovertype and corresponding buffer.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        buffers : num, optional</span>
<span class="sd">            The list of buffer radia in dataset units (meters for ESA worldcover) . The default is 100.</span>
<span class="sd">        aggregate : bool, optional</span>
<span class="sd">            If True, the classes will be aggregated with the corresponding</span>
<span class="sd">            aggregation scheme. The default is True.</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If True, the Datset.metadf will be updated with the generated</span>
<span class="sd">            landcoverfractions. The default is True.</span>
<span class="sd">        gee_map : str, optional</span>
<span class="sd">            The name of the dataset to use. This name should be present in the</span>
<span class="sd">            settings.gee[&#39;gee_dataset_info&#39;]. If aggregat is True, an aggregation</span>
<span class="sd">            scheme should included as well. The default is &#39;worldcover&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        frac_df : pandas.DataFrame</span>
<span class="sd">            A Dataframe with index: name, buffer_radius and the columns are the</span>
<span class="sd">            fractions.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">             import metobs_toolkit</span>

<span class="sd">             # Import data into a Dataset</span>
<span class="sd">             dataset = metobs_toolkit.Dataset()</span>
<span class="sd">             dataset.update_settings(</span>
<span class="sd">                                     input_data_file=metobs_toolkit.demo_datafile,</span>
<span class="sd">                                     input_metadata_file=metobs_toolkit.demo_metadatafile,</span>
<span class="sd">                                     template_file=metobs_toolkit.demo_template,</span>
<span class="sd">                                     )</span>
<span class="sd">             dataset.import_data_from_file()</span>

<span class="sd">             # Get the landcover fractions for multiple buffers, for all stations</span>
<span class="sd">             lc_frac_series = dataset.get_landcover(buffers=[50, 100, 250, 500],</span>
<span class="sd">                                                    aggregate=False)</span>

<span class="sd">             # in addition to the returned dataframe, the metadf attribute is updated aswell</span>
<span class="sd">             print(dataset.metadf)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># connect to gee</span>
        <span class="n">connect_to_gee</span><span class="p">()</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Extracting landcover from </span><span class="si">{</span><span class="n">gee_map</span><span class="si">}</span><span class="s2"> with buffer radius = </span><span class="si">{</span><span class="n">buffer</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Extract landcover fractions for all stations</span>
            <span class="n">lc_frac_df</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">lc_fractions_extractor</span><span class="p">(</span>
                <span class="n">metadf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">,</span>
                <span class="n">mapinfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">gee</span><span class="p">[</span><span class="s2">&quot;gee_dataset_info&quot;</span><span class="p">][</span><span class="n">gee_map</span><span class="p">],</span>
                <span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
                <span class="n">agg</span><span class="o">=</span><span class="n">aggregate</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># add buffer to the index</span>
            <span class="n">lc_frac_df</span><span class="p">[</span><span class="s2">&quot;buffer_radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span>
            <span class="n">lc_frac_df</span> <span class="o">=</span> <span class="n">lc_frac_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;buffer_radius&quot;</span><span class="p">])</span>
            <span class="n">lc_frac_df</span> <span class="o">=</span> <span class="n">lc_frac_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

            <span class="c1"># add to the list</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc_frac_df</span><span class="p">)</span>

        <span class="c1"># concat all df for different buffers to one</span>
        <span class="n">frac_df</span> <span class="o">=</span> <span class="n">concat_save</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span>
        <span class="n">frac_df</span> <span class="o">=</span> <span class="n">frac_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">buf</span> <span class="ow">in</span> <span class="n">frac_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;buffer_radius&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">buf_df</span> <span class="o">=</span> <span class="n">xs_save</span><span class="p">(</span><span class="n">frac_df</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;buffer_radius&quot;</span><span class="p">)</span>
                <span class="n">buf_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="si">}</span><span class="s2">m&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">buf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

                <span class="c1"># overwrite the columns or add them if they did not exist</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadf</span><span class="p">[</span><span class="n">buf_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf_df</span>

        <span class="k">return</span> <span class="n">frac_df</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2023, Thomas Vergauwen.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.4.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>