name: Build and Test Package

on: [push]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
              - name: Checkout code
                uses: actions/checkout@v3

              - name: Set up Python
                uses: actions/setup-python@v4
                with:
                    python-version: '3.9'

              - name: Install Poetry
                run: |
                    curl -sSL https://install.python-poetry.org | python3 -
                    echo "$HOME/.local/bin" >> $GITHUB_PATH

              - name: Remove previous builds
                run: |
                    rm dist/metobs_toolkit-*
                    rm -rf *.egg-info

              - name: Install dependencies
                run: poetry install

              - name: Build the package
                run: poetry build

              - name: Debug dist contents
                run: ls -l dist/

              - name: Upload package artifact
                uses: actions/upload-artifact@v3
                with:
                    name: regular_package
                    path: dist/

    test-install:
        needs: build
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: [3.9, 3.10, 3.11]
        runs-on: ${{ matrix.os }}
        steps:
              - name: Download package artifact
                uses: actions/download-artifact@v3
                with:
                    name: regular_package

              - name: Set up Python
                uses: actions/setup-python@v4
                with:
                    python-version: ${{ matrix.python-version }}

              - name: Install package with pip
                run: |
                    pip install dist/*.whl
